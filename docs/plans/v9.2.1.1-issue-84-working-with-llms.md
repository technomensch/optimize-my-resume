# Plan: v9.2.1.1 - Working with LLMs (Safety & Patterns)

This plan implements a suite of "Stop-on-Error" and "Zero-Deviation" safety patterns to prevent LLM hallucinations and loop-related regressions.

## User Review Required

> [!IMPORTANT]
> This plan modifies core workflows (`implementation-plan.md`, `start-issue-tracking.md`). These changes will impact all future agent sessions by enforcing stricter behavioral guardrails.

## Proposed Changes

### Workflows & Safety Patterns
#### [MODIFY] [implementation-plan.md](../../.agent/workflows/implementation-plan.md)
- Add "Step 0: Verification & Stop-on-Error" to the workflow template.
- Explicitly require the agent to declare `MODE: READ-ONLY ANALYSIS` before proposing changes.

#### [MODIFY] [start-issue-tracking.md](../../.agent/workflows/start-issue-tracking.md)
- Update documentation to include the new safety requirements for complex problem identification.

#### [NEW] [read-only-analysis.md](../../.agent/workflows/read-only-analysis.md)
- **Command:** `/read-only-analysis`
- **Logic:** Locks the agent into a non-destructive state.
- **Constraints:** Restricted to `view_file` and `grep_search`. Requires explicit "Ambiguity Lock" output if logic is circular.

#### [NEW] [execute-plan.md](../../.agent/workflows/execute-plan.md)
- **Command:** `/execute-plan`
- **Logic:** Zero-deviation enforcement.
- **Requirement:** Agent must quote the plan's exact line/instruction before every `replace_file_content` call.

---

### Documentation & Architecture
#### [NEW] [ADR-005-llm-constraint-engineering.md](../../docs/decisions/ADR-005-llm-constraint-engineering.md)
- Formalize "Positive Constraint" and "Pre-flight Check" patterns.
- Document the "Pink Elephant" problem and the project's standardized mitigation strategy.

#### [MODIFY] [Lessons_Learned_Effective_LLM_Constraints.md](../../docs/lessons-learned/process/Lessons_Learned_Effective_LLM_Constraints.md)
- Add cross-reference to ADR-005.

#### [MODIFY] [update-knowledge-graph.md](../../.claude/skills/update-knowledge-graph.md)
- Update skill instructions to recognize the new ADR and safety patterns.

---

### Hotfixes
#### [MODIFY] [v9.2.2-fix-bullet-display-bug.md](../../docs/plans/v9.2.2-fix-bullet-display-bug.md)
- **Change:** Add `Rule: Use /execute-plan for this document. Zero deviation allowed.` at the header.

## Verification Plan

### Automated Verification
1.  **Workflow Registry:** Verify `grep "/read-only-analysis" .agent/workflows/` returns results.
2.  **Relative Path Audit:** Run a script or grep to ensure no absolute paths (e.g., `/Users/`) exist in the new files.

### Manual Verification
1.  **Read-Only Test:** Call `/read-only-analysis` and then try to use `write_to_file`. The agent should halt and explain the constraint.
2.  **Execution Test:** Call `/execute-plan` on `v9.2.2-fix-bullet-display-bug.md` and verify the agent quotes the line before suggesting a change.
3.  **Knowledge Sync:** Run `/update-knowledge-graph` and verify ADR-005 is indexed in `docs/knowledge/patterns.md`.
