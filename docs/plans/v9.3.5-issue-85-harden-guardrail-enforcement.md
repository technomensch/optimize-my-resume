# Plan: Harden Guardrail Enforcement (Issue #85)

**Version:** v9.3.5-issue-85
**Tracking ID:** issue-85
**Status:** üü° IN REVIEW (15/18 tasks complete)
**Branch:** `v9.3.5-issue-85-harden-guardrail-enforcement`
**Last Updated:** 2026-01-28
**GitHub Issue:** [#97](https://github.com/technomensch/optimize-my-resume/issues/97)

---

## üìã Issue Context

**Problem:** When generating resume bullets, multiple LLMs (Claude Sonnet, Gemini via Antigravity) consistently ignore project-specific guardrails and formatting instructions. This results in "Vibe-Coding Drift" where the model defaults to its training bias on resume formatting rather than the project's documented architecture.

**Symptoms Observed:**
- Uses "Phase 1" terminology instead of "Resume Analysis"
- Missing two-line position header schema
- Repeats verb categories within positions (violates G9)
- Missing ASCII verb distribution bars
- Uses shorthand indicators instead of explicit format
- Generic sign-off instead of mandatory grammar recommendation
- No plain text export
- Workflow Routing Confusion - Model ran `ng_summary-generation.md` (Job History Summary) instead of `bo_bullet-generation-instructions.md` (Bullet Generation + Professional Summary)
- **Gemini-specific failures:** Reported "too many guardrails", "couldn't remember everything", "did things in different order", "made assumptions"

**Workflow Disambiguation (for clarity):**
| Workflow | Logic Hub | Trigger | Output |
|----------|-----------|---------|--------|
| **Job History Summary** | `ng_summary-generation.md` (Master Summary section) | Resume Analysis (after position extraction) | Master summary ‚Üí stored in job history file |
| **Bullet + Professional Summary** | `bo_bullet-generation-instructions.md` + `ng_summary-generation.md` (Per-JD section) | "Optimize My Application" (after JD comparison) | Per-JD bullets + customized professional summary ‚Üí user copies to resume |

**Root Cause Analysis:**
1. **Instructional Saturation:** In 4,000+ line context windows, critical guardrails lose attention weight.
2. **Workflow Name Confusion:** Both workflows involve "summary" but serve different purposes.
3. **Implicit "Reference" Language:** Workflow said "Reference" instead of "READ NOW", allowing agents to skip file reading.
4. **Hidden Pre-flight:** Pre-flight table was allowed in "thinking", making it invisible and unaccountable.
5. **Missing Stop-on-Confusion Gate:** No explicit instruction to stop if overwhelmed by rules.
6. **Too Many Indirection Layers:** 4 files to read in sequence, each hop a chance to lose context.

Documented in `Lessons_Learned_Effective_LLM_Constraints.md` v1.1.

**Note:** Original Gemini session chat history was lost, but symptoms are captured above.

---

## üéØ Objective
Remediate recurring failures where the AI agent ignores "Gold Master" instructions (terminology, verb diversity, mandatory headers). We will move rules from passive memory to active execution gates, add explicit workflow disambiguation, and harden the workflow with Stop-on-Confusion gates.

---

## üõ†Ô∏è Implementation Tasks

### Phase 1: Knowledge Graph & Lessons Learned Updates ‚úÖ
- [x] **Task 1.1:** Update `docs/lessons-learned/process/Lessons_Learned_Effective_LLM_Constraints.md` (v1.1)
  - ‚úÖ Added "Instructional Saturation" case study from Jan 28 failures.
  - ‚úÖ Documented the failure of negative constraints in long context windows.
- [x] **Task 1.2:** Update `docs/knowledge/patterns.md`
  - ‚úÖ Added "Pre-flight Rule Mapping" pattern (lines 174-184).
  - ‚úÖ Added "Recency Anchor" pattern (lines 162-171).
- [x] **Task 1.3:** Update `docs/knowledge/gotchas.md`
  - ‚úÖ Added "Vibe-Coding Drift" entry (lines 235-246).

### Phase 2: Workflow Hardening ‚úÖ
- [x] **Task 2.1:** Modify `.agent/workflows/generate-bullets.md`
  - ‚úÖ Added "Step 0: Mandatory Pre-flight Verification" (lines 22-30).
  - ‚úÖ Included validation table with G1, G9, G12, G14, G24, G29, FMT, EXT checks.
- [x] **Task 2.2:** Change "Reference" to "READ NOW" with explicit file read action
  - ‚úÖ Step 2 now says "‚ö†Ô∏è ACTION REQUIRED: OPEN AND READ this file NOW"
  - ‚úÖ Added "Do NOT proceed to Step 3 until you have read Sections 1-5"
- [x] **Task 2.3:** Fix Per-JD Summary vs. Master Summary routing (line 73)
  - ‚úÖ Clarified: "Per-JD Summary Customization" section (lines 229-473), NOT "Master Summary Generation"
  - ‚úÖ Added explicit warning about the distinction
- [x] **Task 2.4:** Make pre-flight table a VISIBLE OUTPUT requirement
  - ‚úÖ Changed from "in thinking or prior" to "AS THE FIRST THING IN ITS RESPONSE (visible to the user)"
- [x] **Task 2.5:** Add "STOP IF CONFUSED" gate with explicit stop-on-error behavior
  - ‚úÖ Added new section at top: "‚ö†Ô∏è CRITICAL: Stop-on-Confusion Gate"
  - ‚úÖ Explicit instruction: "If you are unsure, STOP immediately, ask the user, do NOT assume"
- [x] **Task 2.6:** Add CHECKPOINT confirmations after each file read
  - ‚úÖ Added CHECKPOINT after Step 2 with 3 explicit confirmations required
  - ‚úÖ Added "If you cannot confirm all three, STOP and re-read the file"

### Phase 3: Logic Hub & Active Validation ‚úÖ
- [x] **Task 3.1:** Update `optimization-tools/bullet-optimizer/bo_bullet-generation-instructions.md`
  - ‚úÖ Hardened formatting gates (v9.3.5).
  - ‚úÖ Added FMT section with Position Header Schema, Action Verb Visuals, Bullet Display Indicator.
- [x] **Task 3.2:** Create `optimization-tools/bullet-optimizer/bo_output-validator.md`
  - ‚úÖ Created v1.0 with 8-point "Negative Checklist" for post-generation auditing.
  - ‚úÖ **Hardening (Fix 1):** Added explicit FAIL conditions for G14, G24, and G29.
- [x] **Task 3.3:** Harden G29 in `bo_bullet-generation-instructions.md`
  - ‚úÖ **Hardening (Fix 3):** Added mandatory "Data Integrity Audit" as a visible Step 0 in thinking to prevent metric loss.
- [x] **Task 3.4:** Harden G22 (Symbol & Spacing) in logic hub
  - ‚úÖ **Hardening (Fix 5):** Added explicit em-dash ban and hyphenation rules to `bo_bullet-generation-instructions.md` Section 5.
- [x] **Task 3.5:** Harden G22 in output validator
  - ‚úÖ **Hardening (Fix 6):** Added explicit FAIL conditions for em-dashes and improper spacing to `bo_output-validator.md`.
- [x] **Task 3.6:** Harden G8 (Word Count) in logic hub
  - ‚úÖ **Hardening (Fix 1):** Added explicit "500-Word Hard Cap" and reduction protocol to `bo_bullet-generation-instructions.md`.
- [x] **Task 3.7:** Harden G20 (Acronym Expansion) in logic hub
  - ‚úÖ **Hardening (Fix 2):** Mandated an internal "Acronym Inventory" Step 1.1 to ensure first-use expansion.
- [x] **Task 3.8:** Harden G5/G21 (Limitation Visibility)
  - ‚úÖ **Hardening (Fix 3):** Added mandatory "Limitation Checked?" column to the visible pre-flight table and consolidated logic in the hub.
- [x] **Task 3.9:** Harden G15 (Phrase Uniqueness) in output validator
  - ‚úÖ **Hardening (Fix 4):** Added explicit FAIL condition for repeated 3+ word phrases to `bo_output-validator.md`.
- [x] **Task 3.10:** Harden G11 (Metric Plausibility)
  - ‚úÖ **Hardening (Fix 5):** Added mandatory currency symbol enforcement and logic filters to the logic hub and validator.
- [x] **Task 3.11:** Harden [FMT] Tight Spacing
  - ‚úÖ **Hardening (Fix 6):** Explicitly banned spaced hyphens in Date Ranges and Compound Adjectives across Logic Hub and Validator.
- [x] **Task 3.12:** Broad Terminology Normalization
  - ‚úÖ **Normalization (Fix 7):** Swept codebase to replace legacy 'Phase 1/2/3' with standardized tool names (Resume Analysis, Bullet Optimizer, etc.).
- [x] **Task 3.13:** Markdown Bullet Enforcement
  - ‚úÖ **Hardening (Fix 8):** Mandated `- ` prefix for all bullets in Logic Hub, Gold Master, and Validator to prevent "text block" rendering bugs.

### Phase 4: Gold Master Persistence üî¥
- [x] **Task 4.1:** Verify `<final_recency_anchor>` in `PROJECT-INSTRUCTIONS.md`
  - ‚úÖ Anchor confirmed at absolute bottom of file (v9.3.4 -> v9.3.5 logic sync).
  - ‚úÖ Verified constraints: Terminology, Header Format, ASCII Visuals, EOF String.

**Recommended `<final_recency_anchor>` content:**
```xml
<!-- ========================================================================== -->
<!-- FINAL RECENCY ANCHOR - THE SYSTEM CLOSER                                   -->
<!-- ========================================================================== -->
<!-- This block MUST remain at the absolute end of the file per ADR-005.        -->

<final_recency_anchor id="system_closer" priority="CRITICAL">
  <mandatory_output_constraints>
    <terminology>
      NEVER use: "Phase 1", "Bullet Optimization", "Job Fit Analysis"
      ALWAYS use: "Resume Analysis", "Bullet Optimizer", "Job Fit Analyzer"
    </terminology>
    <header_format>
      Every position MUST include:
      Line 1: [Job Title] at [Company] | [Start] - [End]
      Line 2: Duration: [X years/months]
    </header_format>
    <visual_elements>
      Output MUST include ASCII distribution bars for verb categories.
      Example: `Built: ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë (40%)`
    </visual_elements>
    <terminal_instruction>
      Every bullet generation response MUST end with:
      "[RECOMMENDED] Perform a secondary grammar and spell check using tools like Google Docs, Microsoft Word, or another LLM session to ensure error-free presentation."
    </terminal_instruction>
  </mandatory_output_constraints>
</final_recency_anchor>
```

### Phase 5: Verification & Synchronization üî¥
**Prerequisite:** All Phase 1-4 tasks MUST be ‚úÖ before starting Phase 5.

- [x] **Task 5.1:** Run `/enforce-shadow-sync --auto` to verify terminology and logic across all tiers.
  - ‚úÖ Terminology normalized in `jfa_workflow-router.md`, `shared_keyword_validation.md`, `webgui_artifact_config.md`.
  - ‚úÖ Verified modular consistency.
- [x] **Task 5.2:** Test bullet generation scenario (Position 0 and 1) with new pre-flight gate.
  - ‚úÖ Verified with P0/P1/P2 test run. Confirmed metric preservation and char limits.
- [x] **Task 5.3:** Confirm `bo_output-validator.md` is referenced in `generate-bullets.md` Step 4.
  - ‚úÖ Integration confirmed.

### Phase 6: Workflow Disambiguation ‚úÖ
- [x] **Task 6.1:** Add "THIS IS NOT" Exclusion Header to `ng_summary-generation.md`
  - ‚úÖ Header added with explicit stop-and-route instruction.
- [x] **Task 6.2:** Add "THIS IS NOT" Exclusion Header to `bo_bullet-generation-instructions.md`
  - ‚úÖ Logic hub disambiguated for Per-JD focus.
- [x] **Task 6.3:** Update `jfa_workflow-router.md` to explicitly name both summary types
  - ‚úÖ Added "Optimize My Application" override command.
  - ‚úÖ Added Scenario 3 confirmation template with Master Summary warning.
- [x] **Task 6.4:** Harden "Optimize My Resume" disambiguation (Fix 4)
  - ‚úÖ **Hardening (Fix 4):** Added aggressive choice gate in `jfa_workflow-router.md` to force choice between Master Summary and Per-JD optimization.

### Phase 7: Final Terminology Normalization üî¥
**Prerequisite:** All core logic and hardening tasks MUST be ‚úÖ.

- [ ] **Task 7.1:** Execute broad terminology normalization across codebase.
  - Target files: `Project-GUI-Instructions.md`, `bo_output-validator.md`, `jfa_workflow-router.md`, `ra_jd-parsing.md`.
  - Core files: `core/README.md`, `core/role-type-validation.md`, `core/portfolio-weighting.md`, `core/keyword-context.md`, `core/fit-thresholds.md`, `core/adjacent-technical.md`, `core/industry-context.md`.
  - Documentation/Wireframes: `README-LOCAL-DEV.md`, `wireframes/`.

---

## ‚úÖ Verification Checklist (Expanded)

### Functional Checks
- [ ] Pre-flight table is generated **AS VISIBLE OUTPUT** before bullet output.
- [ ] Final output includes ASCII bars and 2-line headers.
- [x] "Phase 1" terminology is replaced by "Resume Analysis" across all files.
- [x] Response ends with mandatory grammar check recommendation.
- [x] Metric Preservation (G29) audited: No data loss in optimized bullets.
- [x] Character Limits (G24) enforced: All bullets < 210 characters.
- [ ] Agent correctly routes to `bo_bullet-generation-instructions.md` when user requests bullet optimization (not ng_summary Master section).
- [ ] Agent stops and asks for clarification if confused by guardrails.

### Deliverable Checks
- [ ] `bo_output-validator.md` exists at `optimization-tools/bullet-optimizer/bo_output-validator.md`.
- [ ] `PROJECT-INSTRUCTIONS.md` ends with `<final_recency_anchor>` block (no content after it).
- [ ] `/enforce-shadow-sync --auto` returns "Ready to commit ‚úÖ".
- [ ] Both `ng_summary-generation.md` and `bo_bullet-generation-instructions.md` have `<workflow_disambiguation>` headers.
- [ ] `generate-bullets.md` has Stop-on-Confusion gate at top.
- [ ] `generate-bullets.md` has CHECKPOINT after Step 2.

---

## üìÇ Issue Documentation

| Document | Path | Status |
|----------|------|--------|
| Issue Description | `docs/issues/issue-85/issue-85-description.md` | ‚úÖ Populated |
| Solution Approach | `docs/issues/issue-85/solution-approach.md` | ‚úÖ Populated |
| Test Cases | `docs/issues/issue-85/test-cases.md` | ‚úÖ Populated (10 cases) |

---

## ‚ö†Ô∏è Follow-Up Actions (Out of Scope)

### ADR-005 ID Conflict
**Issue:** Two ADR files share the ID `ADR-005`:
- `ADR-005-functional-directory-structure.md`
- `ADR-005-llm-constraint-engineering.md`

**Action:** Renumber one file (e.g., `ADR-010-functional-directory-structure.md`) after this plan is complete.

### Export Path Portability
**Current Status:** ‚úÖ Files updated with environment-aware paths.

---

## üîó Related Documentation

- [Lesson: Effective LLM Constraints](../../lessons-learned/process/Lessons_Learned_Effective_LLM_Constraints.md)
- [Pattern: Pre-flight Rule Mapping](../../knowledge/patterns.md#pre-flight-rule-mapping)
- [Pattern: Recency Anchor](../../knowledge/patterns.md#recency-anchor)
- [Gotcha: Vibe-Coding Drift](../../knowledge/gotchas.md#the-vibe-coding-drift)
- [ADR-009: Hub-and-Spoke Bullet Generation](../../decisions/ADR-009-hub-and-spoke-bullet-generation.md)
