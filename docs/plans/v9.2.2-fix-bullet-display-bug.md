# Implementation Plan: v9.2.2 - Resume Bullet Display Fix

Rule: Use /execute-plan for this document. Zero deviation allowed.

**Status:** Critical bug fix (bullets not displaying despite successful generation)
**Branch:** v9.2.2-fix-bullet-display-bug
**Scope:** Bug fixes only (modularization deferred to v9.2.3)

---

## Root Causes

1. **Brittle `parseOriginalHistory()`**: Returns `[]` on error → validators delete all bullets
2. **Destructive `validatePositionMetadata()`**: Unmatched bullets are dropped, not preserved
3. **No graceful degradation**: Empty reference history crashes the validation pipeline

---

## Implementation Tasks

### Task 1: Fix `parseOriginalHistory()` (~line 3853)

**Current Problem:**
```javascript
async function parseOriginalHistory(...) {
  try {
    const response = await OllamaService.generate(...);
    return JSON.parse(...); // Can fail
  } catch (err) {
    return []; // ← PROBLEM: Empty array causes all bullets deleted
  }
}
```

**Fix Required:**
- Try LLM extraction first (most accurate)
- If fails, use regex fallback with 3 patterns:
  - Pattern 1: "Title at Company (dates)" or "Title @ Company | dates"
  - Pattern 2: Pipe-separated "Title | Company | dates"
  - Pattern 3: Multi-line format (dates on one line, position/company on adjacent)
- Add Levenshtein distance for fuzzy matching
- Return `{ positions, parsingMethod, errors }` (not just array)
- **Never return empty if content exists**

**Expected Return:**
```javascript
{
  positions: [
    { position: "...", company: "...", dates: "...", isIndependent: bool },
    ...
  ],
  parsingMethod: "llm" | "regex" | "failed",
  errors: [] // Empty if successful
}
```

---

### Task 2: Fix `validatePositionMetadata()` (~line 2548)

**Current Problem:**
```javascript
customizedBullets.forEach((bullet, idx) => {
  const matchingJob = jobHistory.find(...);
  if (!matchingJob) {
    errors.push({...});
    return; // ← DROPS THE BULLET - never reaches correctedBullets.push()
  }
  correctedBullets.push(correctedBullet);
});
```

**Fix Required:**
- Change severity from CRITICAL to WARNING for unmatched positions
- Set `requiresRegeneration: false` (don't regenerate for match failures)
- **Always push bullets to correctedBullets**, even if unmatched
- Preserve data instead of deleting it

**Expected Code:**
```javascript
if (!matchingJob) {
  errors.push({
    type: 'POSITION_NOT_IN_HISTORY',
    severity: 'WARNING',
    requiresRegeneration: false,
    message: `Position "${bullet.position}" not in reference history`
  });
  correctedBullets.push(bullet); // ← ALWAYS PRESERVE
  return;
}
```

---

### Task 3: Add `findBestMatch()` Helper

**Purpose:** 4-strategy matching to prevent false negatives

**Strategy Order:**
1. **Exact match** (case-insensitive)
2. **Contains match** (either direction)
3. **Levenshtein distance** ≤ 3 (typos, abbreviations)
4. **Word overlap** > 50% (partial matches)

**Expected Behavior:**
```javascript
findBestMatch("Sr. Engineer", jobHistory)
// Matches: "Senior Engineer", "Sr Engineer", "Engineer Senior"
```

---

### Task 4: Update `validateAndCorrectLLMResponse()` (~line 3660)

**Handle empty reference gracefully:**
- Check if `referenceHistory.positions` is empty
- If empty:
  - Skip position-specific validators (ChronologyDepth, Metadata, Order)
  - Run content-only validators (BulletFormat, VerbDiversity, EmDash, etc.)
  - Return content as-is with warning
- If populated:
  - Run all 25 validators normally

**Expected Return with Empty History:**
```javascript
{
  valid: false,
  errors: [{
    type: 'HISTORY_PARSING_FAILED',
    message: 'Could not parse job history for validation',
    severity: 'HIGH'
  }],
  warnings: ['Position metadata could not be validated'],
  correctedContent: parsedContent, // Return as-is
  summary: {
    validatorsSkipped: 12,
    validatorsRun: 13
  }
}
```

---

## Files to Modify

| File | Location | Changes |
|------|----------|---------|
| `src/components/Should-I-Apply-local.jsx` | Line 3853 | Fix parseOriginalHistory |
| `src/components/Should-I-Apply-local.jsx` | Line 2548 | Fix validatePositionMetadata |
| `src/components/Should-I-Apply-local.jsx` | New | Add findBestMatch helper |
| `src/components/Should-I-Apply-local.jsx` | Line 3660 | Handle empty reference |
| `claude-artifacts/Should-I-Apply-webgui.jsx` | Same | Mirror all changes |

---

## Verification Checklist

- [ ] Bullets display even if history parsing fails (messy input)
- [ ] Bullets display with standard formats (all 3 regex patterns tested)
- [ ] Keyword coverage report shows all positions
- [ ] Regeneration loop still works for other validators
- [ ] No console errors with malformed history
- [ ] Warning messages appear when history parsing fails

---

## Expected Outcome

✅ Generated bullets always display (never silently deleted)
✅ Reference history falls back gracefully
✅ Validation warnings explain what was skipped
✅ Feature works in production (Claude Artifacts)

---

## Next: v9.2.3 - Modularization (Deferred)

See `docs/plans/v9.2.3-modularization.md`
