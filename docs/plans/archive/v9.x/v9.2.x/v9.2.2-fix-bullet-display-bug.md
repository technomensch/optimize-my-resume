# Implementation Plan: v9.2.2 - Validation Pipeline Implementation & Bullet Display Fix

Rule: Use /execute-plan for this document. Zero deviation allowed.

**Status:** Implementation from Scratch (incorporating v9.2.1 design + v9.2.2 safety)
**Branch:** v9.2.2-fix-bullet-display-bug
**Scope:** Full validation pipeline implementation (13 validators)

---

## Root Causes (Retroactive Analysis)

1. **Design Gap**: The validation layer was designed in v9.2.1 but never actually implemented in the codebase.
2. **Data Loss**: The existing UI code was optimized for generation but lacked the "Gold Master" verification layer, leading to metadata mismatches.
3. **Loop Fragility**: Without a validation loop, the system has no way to recover from LLM hallucination of position titles.

---

## Implementation Tasks

### Task 1: `parseOriginalHistory()` Implementation

**Location:** `src/components/Should-I-Apply-local.jsx`
**Insert Point:** After `generateCustomizedContent` state block.

**Logic:**
- Input: `jobHistorySource.content`
- 1. First Pass: Use a light LLM extraction (Ollama) to extract `{ position, company, dates, bullets }` for ALL positions.
- 2. âš ï¸ **FALLBACK (v9.2.2 Safety)**: If LLM fails or returns empty, run regex parser with 3 patterns:
  - Pattern A: `Title at Company (Date range)`
  - Pattern B: `Title | Company | Dates`
  - Pattern C: `## ðŸ¢ Position: ...`
- 3. Return: `{ positions: [...], parsingMethod: 'llm'|'regex', errors: [] }`

---

### Task 2: Core Validation Engine (`validateAndCorrectLLMResponse`)

**Logic:**
- 1. **Step 0 (Constraint Check)**: If `referenceHistory` is empty, log HIGH warning and return `parsedContent` as-is (Graceful Degradation).
- 2. Run 13 Validators in sequence:
  - **Metadata**: `validatePositionMetadata` (Matches bullets to history - uses `findBestMatch`)
  - **Logic**: `validateChronologyDepth`, `validateChronologicalOrder`
  - **Format**: `validateBulletCounts`, `validateBulletFormat` (â‰¤210 chars, verb diversity)
  - **Metric**: `validateMetricPreservation` (#29), `validateMetricTraceability` (#1)
  - **Synthesis**: `validateSummaryAbstraction` (#3), `validateSummaryMetrics` (#13)
  - **Context**: `validateKeywordEvidence` (#32), `validateNarrativeFit` (#33)
- 3. **Non-Destructive Fix (v9.2.2 Safety)**: Every validator MUST use `correctedBullets.push(bullet)` even if it fails validation (preserves display).

---

### Task 3: Helper Functions (`findBestMatch`, etc.)

**`findBestMatch()` Logic:**
1. Exact match (case-insensitive)
2. Fuzzy match (word overlap > 50%)
3. Levenshtein distance â‰¤ 3
4. Company-only fallback

---

### Task 4: UI Integration

- Insert into `generateCustomizedContent()` after `JSON.parse(jsonString)`.
- Replace the direct `setGeneratedContent(parsedContent)` with:
```javascript
const validationResult = await validateAndCorrectLLMResponse(parsedContent, referenceHistory);
setGeneratedContent(validationResult.correctedContent);
// Log errors/warnings to developer console or hidden debug area
```

---

## Files to Modify

| File | Location | Changes |
|------|----------|---------|
| `src/components/Should-I-Apply-local.jsx` | Line 809 | Insert full validation pipeline |
| `claude-artifacts/Should-I-Apply-webgui.jsx` | Same | Mirror implementation |

---

## Verification Checklist

- [ ] `parseOriginalHistory` returns data for malformed markdown input (regex test).
- [ ] Bullets for "Position X" are preserved even if "Position X" is not in history (non-destructive test).
- [ ] Summary metrics trace correctly to bullets.
- [ ] Fit score remains consistent.

---

## Success Criteria

âœ… Validation pipeline exists and runs on every generation.
âœ… Generated bullets NO LONGER disappear from the UI.
âœ… Character limits (210) are enforced per position.
âœ… metrics are preserved across rewrites.
