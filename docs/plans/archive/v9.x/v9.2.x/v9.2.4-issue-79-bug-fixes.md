# Implementation Plan: v9.2.4 - Bug Fixes for Issue #79

**Status:** Planned
**Branch:** `v9.2.3-modularization` (incremental)
**Scope:** Fix 3 remaining bugs from user testing + optional further modularization

---

## Prerequisites

v9.2.3 must be committed first:
```bash
git add -A && git commit -m "feat(v9.2.3): modularize bullet validators into 8 modules

- Extract 25 validators from Should-I-Apply components
- Create validator-pipeline.js master orchestrator
- Reduce JSX files from 4076 to ~2500 lines (38% reduction)

Co-Authored-By: Gemini <noreply@google.com>"
```

---

## Bug Summary

| Bug | Symptom | Location | Root Cause |
|-----|---------|----------|------------|
| 1 | First job shows JD company | `validatePositionMetadata()` line 153 | `undefined !== "Company"` is true, so correction skipped |
| 2 | Second job has no company | Same as Bug 1 | Empty string not caught by `!==` check |
| 3 | Missing positions | `validateChronologyDepth()` line 96 | `autoCorrectPositions()` only maps, can't add |

---

## Part A: Bug Fixes

### Bug 1 & 2: Company Issues

**File:** `src/validators/bullet-generation/core-validators.js`
**Function:** `validatePositionMetadata()`
**Line:** 153

**Current Code:**
```javascript
if (bullet.company !== matchingJob.company) {
```

**Fixed Code:**
```javascript
if (!bullet.company || bullet.company.trim() === '' || bullet.company !== matchingJob.company) {
```

**Rationale:** Explicit check for null/undefined/empty ensures company is ALWAYS corrected when missing or wrong.

---

### Bug 3: Missing Positions

**File:** `src/validators/bullet-generation/core-validators.js`
**Function:** `validateChronologyDepth()`

**Step 1:** Add new helper function after `autoCorrectPositions()` (~line 27):

```javascript
/**
 * Creates skeleton position entries for positions missing from LLM output
 * Skeletons have empty bullets array - will trigger WRONG_BULLET_COUNT for regeneration
 */
export function addMissingPositionSkeletons(customizedBullets, missingPositions) {
    const skeletons = missingPositions.map(mp => ({
        position: mp.position,
        company: mp.company,
        dates: mp.dates,
        bullets: [] // Empty triggers regeneration
    }));
    return [...customizedBullets, ...skeletons];
}
```

**Step 2:** Update `validateChronologyDepth()` return logic (~lines 70-97):

```javascript
// After missingPositions detection (line 67), add skeletons
let correctedBullets = customizedBullets;
if (missingPositions.length > 0) {
    correctedBullets = addMissingPositionSkeletons(correctedBullets, missingPositions);
}

// Filter extra positions from correctedBullets (not original)
const filteredBullets = correctedBullets.filter(cb => {
    const matchingJob = jobHistory.find(jh =>
        jh.position.toLowerCase().trim() === cb.position.toLowerCase().trim()
    );
    if (!matchingJob) return false; // Remove if not in history

    return eligiblePositions.some(ep =>
        ep.position.toLowerCase().trim() === cb.position.toLowerCase().trim()
    );
});

return {
    valid: errors.length === 0,
    errors,
    eligiblePositions,
    correctedBullets: filteredBullets
};
```

---

## Part B: Further Modularization (Optional)

### Module: `generation-helpers.js`

Extract from JSX lines 2428-2513:

```javascript
// src/validators/bullet-generation/generation-helpers.js
import OllamaService from '../../services/ollamaService';
import { parseOriginalHistory, validateAndCorrectLLMResponse, determineExperienceLevel } from './index.js';

export async function callLLM(model, prompt, options) {
    const result = await OllamaService.generate(model, prompt, options);
    if (!result.success) {
        throw new Error(`LLM call failed: ${result.error}`);
    }
    return result.text;
}

export function parseJSONResponse(responseText) {
    let cleaned = responseText.trim();
    cleaned = cleaned.replace(/```json\s*/g, '').replace(/```\s*/g, '');
    const jsonStart = cleaned.indexOf('{');
    const jsonEnd = cleaned.lastIndexOf('}');
    if (jsonStart === -1 || jsonEnd === -1) {
        throw new Error('No JSON found in response');
    }
    return JSON.parse(cleaned.substring(jsonStart, jsonEnd + 1));
}

export async function generateWithValidationLoop(
    selectedModel,
    baseGenerationPrompt,
    jobHistorySource,
    jobDescription,
    keywordsToUse,
    honestLimitations,
    ollamaOptions = { temperature: 0.3, max_tokens: 4000 },
    resumeSource = null
) {
    // ... existing implementation
}
```

### Module: `prompt-templates.js`

Extract large prompts from JSX:

```javascript
// src/validators/bullet-generation/prompt-templates.js
export const ANALYSIS_PROMPT_TEMPLATE = `You are a Job Fit Assessment expert...`;
export const GENERATION_PROMPT_TEMPLATE = `You are a Resume Optimization expert...`;

export function buildAnalysisPrompt(resume, jobDescription, keywords) {
    return ANALYSIS_PROMPT_TEMPLATE
        .replace('{{RESUME}}', resume)
        .replace('{{JOB_DESCRIPTION}}', jobDescription);
}

export function buildGenerationPrompt(jobHistory, keywords, limitations) {
    return GENERATION_PROMPT_TEMPLATE
        .replace('{{JOB_HISTORY}}', jobHistory)
        .replace('{{KEYWORDS}}', keywords.join(', '));
}
```

---

## Files to Modify

| File | Action | Lines Change |
|------|--------|--------------|
| `core-validators.js` | Fix bugs 1-3 | +30 |
| `generation-helpers.js` | Create (optional) | +90 |
| `prompt-templates.js` | Create (optional) | +200 |
| `index.js` | Add exports (if Part B done) | +2 |
| `Should-I-Apply-local.jsx` | Import new modules (if Part B) | -290 |
| `Should-I-Apply-webgui.jsx` | Same as local | -290 |

---

## Verification Criteria

### Bug Fixes (Required)
1. First job shows history company (not JD company)
2. Second job shows company name (not empty)
3. All eligible positions displayed (skeletons added for missing)

### Modularization (Optional)
4. `wc -l src/components/Should-I-Apply-local.jsx` < 2300 lines
5. New modules export correctly from index.js

---

## Test Cases

### Test Case 1: Company Correction
**Input:** LLM returns `{ company: "BigCorp" }` but history has `{ company: "Acme Inc" }`
**Expected:** Output shows "Acme Inc"

### Test Case 2: Empty Company
**Input:** LLM returns `{ company: "" }` or `{ company: undefined }`
**Expected:** Output shows history company

### Test Case 3: Missing Position
**Input:** History has 3 positions, LLM only returns 2
**Expected:** All 3 positions in output (missing one has empty bullets, triggers regen)

---

## Reference

- [v9.2.3 Plan](v9.2.3-modularization.md) - Modularization details
- [Issue #79 Log](../issues/issue-79/implementation-log.md) - Full history
- [ADR-005](../decisions/ADR-005-llm-constraint-engineering.md) - Safety patterns
