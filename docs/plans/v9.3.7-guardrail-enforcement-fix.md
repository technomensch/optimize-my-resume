# v9.3.7 - Guardrail Enforcement Fix (Active Structural Constraints)

**Branch:** `v9.3.7-guardrail-enforcement-fix`
**Target Release:** v9.3.7
**Type:** Patch Version (Critical Hardening)
**Priority:** CRITICAL
**Status:** Planning
**Local Issue ID:** issue-98
**GitHub Continuations:** #97 (Guardrail Hardening), #99 (ENH-008 Governance), #101 (TBD)
**Triggered By:** Production Test Failure - 2026-01-29

---

## Executive Summary

**Problem:** v9.3.6 built comprehensive guardrail documentation and enforcement mechanisms, but production testing revealed **complete enforcement failure**. The system generated content that violated guardrails despite claiming compliance.

**Root Cause:** Passive instruction-based enforcement cannot prevent LLM drift in real-world usage. Documentation alone does not force compliance.

**Solution:** Implement Four-Layer Enforcement Strategy moving from passive instructions to active structural constraints.

---

## Failure Context (v9.3.6)

### What Was Built
- 37 standardized guardrails (G1-G37) in registry format
- 3-Stage Checkpoint Pattern (Budget → Per-Bullet → Reconciliation)
- Institutional knowledge (gotchas, lessons learned, ADRs)
- Validation checklist (bo_output-validator.md)

### What Failed
Production test (2026-01-29) showed:
- Jobs left out of resume bullets
- Chronological ordering violated
- Professional summary word count unaccounted
- Action verb distribution completely ignored
- **User comment:** "i have spent 2 days hardening the guardrails and everything was ignored"

---

## Four-Layer Enforcement Strategy

Implementation follows Gemini's analysis and extends existing 3-Stage Checkpoint pattern.

### Layer 1: Structural Prompt Logic (The Rule)

**What:** Hard mathematical limits in prompt template

**Implementation:**
```javascript
// In prompt-templates.js or bo_bullet-generation-instructions.md
GUARDRAIL_ENFORCEMENT = {
  POSITION_DISTRIBUTION: {
    rule: "Max N bullets per position (derived from total word budget)",
    validation: "Assert bullets.length === expectedCount before delivery"
  },
  CHRONOLOGICAL_ORDERING: {
    rule: "Positions must be sorted by start_date DESC",
    validation: "Assert positionList[i].startDate > positionList[i+1].startDate"
  },
  WORD_COUNT_BUDGET: {
    rule: "Total resume bullets + summary = fixed budget (e.g., 800 words)",
    validation: "Assert sum(all_content_lengths) <= BUDGET_MAX"
  },
  ACTION_VERB_DIVERSITY: {
    rule: "Max 2 bullets per verb category (Built, Led, Managed, etc)",
    validation: "Assert category_distribution.max() <= 2"
  }
}
```

**Where Enforced:**
- BEFORE generation: Pre-flight checklist validates constraints are logically possible
- DURING generation: Per-bullet gates check math is maintained
- AFTER generation: Final reconciliation validates all math before output

---

### Layer 2: "Proof of Work" Schema (The Gate)

**What:** JSON validation gates that require evidence citations

**Current Problem:** Guardrails claim compliance without showing work.

**Fix:** Extend response schema to require structural proof:

```json
{
  "position": "Senior Engineer",
  "bullets": [
    {
      "text": "Modified bullet text...",
      "charCount": 145,
      "verbCategory": "Built",
      "sourceEvidence": "Original text: 'Scales backend services across multiple regions'",
      "guardrailValidation": {
        "G1_MetricTraceability": {
          "status": "PASS",
          "metric_found": "50+ deployments",
          "validation_proof": "Metric present in source evidence"
        },
        "G5_ActionVerbQuality": {
          "status": "PASS",
          "verb_category": "Built",
          "validation_proof": "Verb is G5-approved, first use of 'Built' in position"
        },
        "G24_CharacterLimit": {
          "status": "PASS",
          "char_count": 145,
          "validation_proof": "Within 100-210 char range"
        }
      }
    }
  ],
  "reconciliation": {
    "total_bullets_generated": 12,
    "expected_bullets": 12,
    "word_count_total": 798,
    "budget_max": 800,
    "all_guardrails_passed": true,
    "validation_timestamp": "2026-01-30T15:40:00Z"
  }
}
```

**Validation Gate Logic:**
- If `guardrailValidation` missing OR `all_guardrails_passed !== true` → REJECT output
- Require explicit proof for EACH guardrail, not aggregate claim
- No "validation in thinking block" — validation must be visible in structured output

---

### Layer 3: Workflow Multi-Turn (The Pause)

**What:** Break monolithic generation into reviewable stages with user confirmation

**Current:** Single API call, user never sees intermediate state

**Fix:** Two-turn workflow:

**Turn 1: Constraint Validation**
```
INPUT:
- Resume/job history
- Target word budget
- Number of positions
- Keywords to target

OUTPUT:
- Budget allocation plan (word count per position)
- Chronological ordering strategy
- Keyword distribution map
- Constraint feasibility assessment

USER ACTION: Review and confirm plan is correct
```

**Turn 2: Constrained Generation**
```
INPUT:
- Approved budget plan from Turn 1
- Position ordering from Turn 1
- Keyword map from Turn 1
- Generate actual bullets WITHIN approved constraints

OUTPUT:
- Bullets with full guardrail validation
- Reconciliation table showing all constraints met
- Keyword coverage report

USER ACTION: Accept or request modifications
```

**Benefits:**
- User sees constraints BEFORE generation
- Impossible constraints caught early
- LLM focuses on quality within known feasible bounds
- Separation of concerns (planning vs execution)

---

### Layer 4: Modular Injection (The Knowledge)

**What:** Literal guardrail content injected as "hard code" not suggestions

**Current Problem:** Guardrails referenced as "follow these patterns" — easy to ignore

**Fix:** Inject actual guardrail definitions into prompt as pseudo-code:

```
System Instructions:
---BEGIN INJECTED GUARDRAILS---

G1_METRIC_TRACEABILITY (REQUIRED):
```javascript
// Every metric in output must trace to source evidence
if (bullet.hasMetric()) {
  assert(bullet.sourceEvidence.includes(bullet.metric));
}
```

G5_ACTION_VERB_QUALITY (REQUIRED):
```javascript
// Action verb must be in approved list and first use per category
const approvedVerbs = ['Built', 'Led', 'Managed', 'Improved', 'Collaborated'];
assert(approvedVerbs.includes(bullet.verb));
assert(positionBullets.filter(b => b.verbCategory === category).length < 3);
```

G24_CHARACTER_LIMITS (REQUIRED):
```javascript
// Every bullet must be between 100-210 characters
assert(bullet.text.length >= 100);
assert(bullet.text.length <= 210);
```

---END INJECTED GUARDRAILS---
```

**Where Injected:**
- `bo_bullet-generation-instructions.md` — Master source of truth
- PROJECT-INSTRUCTIONS.md — Gets literal copy-paste from module
- Prompt templates — Literal guardrail code included in API request

**Key Principle:** LLM sees guardrails as structural requirement code, not advisory guidance.

---

## Implementation Plan

### Phase 1: Update Prompt Templates (LAYER 1 + 4)

**File:** `docs/workflow-templates/bullet-generation-prompt-template.md`

**Changes:**
1. Add GUARDRAIL_ENFORCEMENT section with hard mathematical limits
2. Inject literal guardrail code (bo_bullet-generation-instructions.md content)
3. Add MUST/MUST NOT language for structural requirements
4. Remove suggestion-based language ("try to", "aim for")

**Test:** Single-turn generation with new prompt → verify guardrail violations caught

---

### Phase 2: Implement Response Validation Schema (LAYER 2)

**File:** `docs/workflow-templates/guardrail-validation-schema.md` (NEW)

**Changes:**
1. Define JSON response structure with validation gates
2. Create validator function checklist
3. Document rejection criteria (when to FAIL vs PASS)
4. Add reconciliation table template

**Implementation:**
- Extended JSON response with `guardrailValidation` field
- Per-guardrail PASS/FAIL status with proof
- `all_guardrails_passed` gate before output accepted

**Test:** Generate bullets → validate against schema → verify all guardrails have proof

---

### Phase 3: Implement Two-Turn Workflow (LAYER 3)

**File:** `docs/workflow-templates/constrained-generation-workflow.md` (NEW)

**Changes:**
1. Turn 1 prompt: Budget planning, constraint validation
2. Turn 2 prompt: Constrained generation with approved plan
3. User confirmation step between turns (if applicable)
4. Fallback logic if constraints are impossible

**Implementation:**
- First API call: Budget/planning
- Display plan to user (or validate programmatically)
- Second API call: Generation with constraints
- Return validated results

**Test:** Multi-turn workflow → confirm constraints enforced in Turn 2

---

### Phase 4: Knowledge Injection Setup (LAYER 4)

**File:** `docs/workflow-templates/guardrail-injection-manifest.md` (NEW)

**Changes:**
1. List all guardrails (G1-G37) that need injection
2. Extract literal code from bo_bullet-generation-instructions.md
3. Create injection template for prompt builders
4. Document which guardrails are "injectable" vs "advisory"

**Implementation:**
- Manifest of guardrails to inject
- Actual injection code in prompt templates
- Verification that injected content matches source

**Test:** Prompt includes all critical guardrails as pseudo-code

---

## Files to Create/Modify

### New Files (Created)
- `docs/plans/v9.3.7-guardrail-enforcement-fix.md` (this file)
- `docs/issues/v9.3.7/` (local issue folder)
- `docs/workflow-templates/guardrail-validation-schema.md`
- `docs/workflow-templates/constrained-generation-workflow.md`
- `docs/workflow-templates/guardrail-injection-manifest.md`

### Modified Files
- `docs/workflow-templates/bullet-generation-prompt-template.md` — Add Layer 1 + 4
- `bo_bullet-generation-instructions.md` — Ensure all guardrails are injectable
- `PROJECT-INSTRUCTIONS.md` — Reference new validation schema and workflow
- `docs/issue-tracker.md` — Add v9.3.7 entry
- `docs/knowledge/gotchas.md` — Document enforcement failure pattern
- `docs/decisions/ADR-011-structural-enforcement-over-passive.md` (NEW) — Formalize decision

---

## Success Criteria

- [ ] Layer 1: Hard mathematical limits in prompt template with MUST language
- [ ] Layer 2: JSON schema with per-guardrail validation proof required
- [ ] Layer 3: Two-turn workflow implemented with constraint validation Turn 1
- [ ] Layer 4: All critical guardrails (G1-G37) injected as pseudo-code in prompt
- [ ] Validation gates reject output if guardrails not explicitly verified
- [ ] Reconciliation table shows all constraints met with proof
- [ ] Production test re-run: All guardrails enforced, violations caught
- [ ] Documentation updated to reflect structural enforcement approach

---

## Testing Strategy

### Unit Tests
- Prompt includes all guardrails as code (not just references)
- Validation schema rejects malformed responses
- Two-turn workflow preserves constraints across turns

### Integration Tests
- Full bullet generation workflow enforces all layers
- Guardrail violations caught before output
- Reconciliation table is accurate

### Production Test (Final)
- Real resume + JD (same test case as v9.3.6 failure)
- Verify no guardrail violations in output
- Confirm enforcement is visible (not hidden in thinking blocks)

---

## Risk Mitigation

**Risk:** Guardrails are too strict, generation becomes impossible

**Mitigation:** Layer 3 (multi-turn) validates feasibility in Turn 1 before committing to generation

**Risk:** LLM ignores injected code just like instructions

**Mitigation:** Make guardrails structural requirements (JSON validation gates), not request instructions. Invalid output is rejected, not accepted.

**Risk:** Performance impact from two-turn workflow

**Mitigation:** Turn 1 is fast (budget math only), Turn 2 is standard generation. Overall time: 1-2x normal.

---

## Related Issues

- GitHub #97 (Initial failure report)
- ADR-010 (Guardrail Hardening Pattern) - superseded by Layer approach
- v9.3.6 (Foundation work: Registry, 3-Stage Checkpoint, documentation)

---

## Task Allocation: Sonnet vs Opus

### Sonnet's Tasks (Analysis & Design)

1. **Comparison Analysis**
   - Read Gemini's Four-Layer Enforcement Strategy recommendation
   - Compare against v9.3.6 enforcement system that failed
   - Identify gaps in v9.3.6 that Gemini's layers address
   - Update plan with merged insights from both approaches

2. **Design Validation**
   - Validate Four-Layer approach is complete and non-redundant
   - Identify implementation sequence and dependencies
   - Flag any architectural risks or conflicts
   - Create detailed technical specifications for each layer

3. **Documentation Review**
   - Ensure plan aligns with start-issue-tracking.md workflow
   - Verify all steps 0-7 are properly documented
   - Check that solution-approach is complete for Opus handoff

### Opus's Tasks (Implementation)

1. **Layer 1 & 4 Implementation** (Prompt Templates)
   - Update `bullet-generation-prompt-template.md`
   - Add hard mathematical limits (LAYER 1)
   - Inject guardrail code as pseudo-code (LAYER 4)
   - Test with single-turn generation

2. **Layer 2 Implementation** (Validation Schema)
   - Create `guardrail-validation-schema.md`
   - Implement per-guardrail PASS/FAIL gates
   - Create validator function checklist
   - Test schema with sample responses

3. **Layer 3 Implementation** (Two-Turn Workflow)
   - Create `constrained-generation-workflow.md`
   - Implement Turn 1: Budget planning
   - Implement Turn 2: Constrained generation
   - Test workflow end-to-end

4. **Integration & Testing**
   - Run production test (v9.3.6 failure case)
   - Verify all guardrails enforced
   - Confirm violations caught before output
   - Document enforcement proof in reconciliation

5. **Knowledge Graph & Documentation**
   - Update `docs/knowledge/gotchas.md` with enforcement patterns
   - Create `ADR-011-structural-enforcement-over-passive.md`
   - Update issue-tracker.md with completion status
   - Update PROJECT-INSTRUCTIONS.md with new enforcement workflow

---

## Sonnet Analysis Results (2026-01-30)

### General Four-Layer Strategy Validation

**Finding:** The Four-Layer Enforcement Strategy directly addresses every failure mode observed in v9.3.6. The strategy is architecturally sound and complete. No additional layers required.

**Gap Analysis:**
- ✅ Layer 1 fixes: positions omitted, wrong order, budget ignored
- ✅ Layer 2 fixes: invisible validation, fake compliance claims
- ✅ Layer 3 fixes: no validation before generation, impossible constraints not caught
- ✅ Layer 4 fixes: guardrails treated as suggestions instead of requirements
- ✅ No gaps identified - all v9.3.6 failure modes covered
- ✅ Redundancy is intentional (defense-in-depth)

**Implementation Sequence Validated:** Layer 3 (workflow foundation) → Layer 1 (structural constraints) → Layer 2 (validation schema) → Layer 4 (code injection)

### Gemini Custom Keyword Strategy Comparison

**Finding:** Gemini's Four-Layer Strategy for custom keyword enforcement is architecturally **identical** to the general Four-Layer Strategy. Gemini independently applied the same pattern to a specific guardrail problem.

**Key Validation:**
- Gemini Layer 1: Keyword density limits (`Max 5 custom keywords per position`)
- Gemini Layer 2: JSON schema with `sourceEvidence` for each `customKeyword`
- Gemini Layer 3: Two-turn workflow (Keyword Map → Bullets)
- Gemini Layer 4: Inject `bo_keyword_handling.md` literally

**What This Proves:**
1. The Four-Layer architecture is generalizable (works for specific and comprehensive enforcement)
2. All four layers are necessary (Gemini needed all four for custom keywords alone)
3. The pattern is correct (independent derivation validates approach)

### Recommended Implementation Path: Hybrid Approach

**Rationale:** Gemini's recommendation suggests implementing custom keywords first as proof-of-concept, then extending to all guardrails.

**Phase 1: Custom Keywords (Quick Win)**
- Apply Four-Layer pattern to custom keyword enforcement
- Timeline: 1-2 hours
- Validates the architecture works in production
- Addresses Gemini's identified issue

**Phase 2: All Guardrails (Comprehensive)**
- Extend same architecture to all G1-G37 guardrails
- Timeline: 3-4 hours
- Addresses ALL v9.3.6 failures
- Same implementation sequence: Layer 3 → 1 → 2 → 4

**Total Timeline:** ~4-6 hours (same as original estimate)

**Benefits:**
- Early validation that architecture works (reduces Phase 2 risk)
- Immediate fix for custom keyword violations
- Full enforcement coverage after Phase 2

---

## Notes

This is the "structural constraints" pivot mentioned in the enforcement failure case study. Moving from passive documentation (v9.3.6) to active structural validation (v9.3.7).

**Key Philosophy Change:**
- v9.3.6: "Here are guardrails to follow" → Often ignored
- v9.3.7: "Your response MUST pass these gates" → Structurally enforced

The difference is validation gates that reject invalid output, not instructions that can be ignored.

**Continuation Context:**
- Builds on #97 (Guardrail Registry & Hardening)
- Extends #99 (ENH-008 Governance modularization)
- Related to #101 (TBD - enforcement framework)
- Addresses root cause failure identified in production testing
