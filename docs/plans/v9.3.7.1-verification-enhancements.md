# Implementation Plan: v9.3.7.1-verification-enhancements

**STATUS:** üî¥ STOPPED (Waiting for Manual Approval of Step 1)
**GOVERNANCE:** Atomic Approval Required (Step-by-Step)
**BEHAVIOR LOCKS:**
- [x] Zero-Deviation Execution
- [x] Stop-on-Confusion (Interactive Gate)
- [x] Visible Result Validation (Post-Step Tables)

**Local Tracking ID:** issue-98
**GitHub Issue:** [#98](https://github.com/technomensch/optimize-my-resume/issues/98)
**Version:** v9.3.7.1 (Patch - Verification Enhancements)
**Type:** üõ°Ô∏è Hardening
**Parent Version:** v9.3.7 (Guardrail Enforcement Fix)
**Created:** 2026-01-31
**Branch:** `v9.3.7.1-verification-enhancements`

---

## Context

After Gemini implemented v9.3.7 (Four-Layer Enforcement Strategy), Opus performed a second-pass verification and discovered 3 integration gaps plus 2 items from v9.3.6 plan that remain relevant. This patch completes the enforcement architecture before production deployment.

**Parent Work:** v9.3.7-guardrail-enforcement-fix (Gemini)
- Created validate_bullets.py with Layer 0 sanitization ‚úÖ
- Created compliance_tracker.py (standalone) ‚úÖ
- Created 3 workflow templates ‚úÖ
- Implemented Four-Layer Enforcement Strategy ‚úÖ

**Gaps Identified:**
- Pipeline integration missing between validator and tracker
- Template content completeness not verified
- G40 doesn't reference external validator
- generate-bullets.md uses "Fail-Open" instead of "Fail-Closed"
- v9.3.6 user verification checklist never implemented
- Platform 2 token optimization not verified

---

## Execution Protocol

1. **Present Logic:** Before every tool call, state the intended change and logic.
2. **Wait:** Request explicit "YES" to proceed.
3. **Execute:** Run the tool.
4. **Validate:** Display the Validation Check table (see below).

---

## Implementation Tasks

### Item 7: Integrate compliance_tracker.py Pipeline

**Status:** HIGH PRIORITY - Infrastructure exists but disconnected

**Current State:**
- `scripts/validate_bullets.py` - ‚úÖ Runs standalone with 8 validation checks
- `scripts/compliance_tracker.py` - ‚úÖ Exists but never invoked

**Changes Required:**

1. **Modify validate_bullets.py** (lines 405-409):
   - After `results = validate_output(text)`, add compliance logging call
   - Format results as JSON for tracker consumption
   - Invoke compliance_tracker.log_compliance() with platform parameter

2. **Modify compliance_tracker.py** (lines 17-51):
   - Accept results list directly (not just stdin)
   - Add platform detection logic
   - Create `docs/governance/compliance_logs.json` if missing

3. **Create docs/governance/ directory**

**Validation:**
| Check | Expected | Status |
|-------|----------|--------|
| validate_bullets.py calls tracker | YES | [ ] |
| compliance_logs.json created | YES | [ ] |
| Platform thresholds monitored | P2:<50%, P3:<40% | [ ] |
| Compliance rate logged | Per session | [ ] |

---

### Item 8: Verify Workflow Template Completeness

**Status:** HIGH PRIORITY - Files created but content not verified

**Files to Review:**
1. `docs/workflow-templates/guardrail-validation-schema.md`
2. `docs/workflow-templates/constrained-generation-workflow.md`
3. `docs/workflow-templates/guardrail-injection-manifest.md`

**Verification Checklist:**

**guardrail-validation-schema.md:**
- [ ] Contains G40-Stage1 (Budget Allocation Table) JSON structure
- [ ] Contains G40-Stage2 (Per-Bullet Gates) validation rules
- [ ] Contains G40-Stage3 (Final Reconciliation) table format
- [ ] Includes all critical guardrails (G1, G8, G9, G12, G24, G29)

**constrained-generation-workflow.md:**
- [ ] Turn 1: Planning stage fully defined
- [ ] Turn 1: Example Budget Allocation Table included
- [ ] Turn 2: Execution stage fully defined
- [ ] Turn 2: Example Final Reconciliation Table included
- [ ] User approval gates between turns documented

**guardrail-injection-manifest.md:**
- [ ] Layer 1 injection points mapped (structural logic)
- [ ] Layer 2 injection points mapped (proof of work)
- [ ] Layer 3 injection points mapped (multi-turn workflow)
- [ ] Layer 4 injection points mapped (modular code)

**Validation:**
| Template | Content Complete | Status |
|----------|------------------|--------|
| guardrail-validation-schema.md | All 3 stages | [ ] |
| constrained-generation-workflow.md | Both turns + examples | [ ] |
| guardrail-injection-manifest.md | All 4 layers | [ ] |

---

### Item 9: Add Fail-Closed Language to G40 and generate-bullets.md

**Status:** CRITICAL - Enforcement explicitness gap

**Problem 1: G40 Missing External Validator Reference**

**File:** `PROJECT-INSTRUCTIONS.md`
**Location:** Line 4287 (`<recursive_constraint_validation id="G40">`)

**Current State:**
```xml
<recursive_constraint_validation id="G40" priority="CRITICAL">
  <intent>
    Enforce absolute guardrail compliance through 3-Layer Redundancy System
  </intent>
  <fallback_sequence>
    IF Actual Word Count > 500:
    1. Identify oldest positions (e.g., P8, P7).
    2. Remove bullets from oldest positions first until total is < 500.
    3. If still over, compress bullets while preserving metrics.
    4. RE-RUN Checkpoint 3 Validation.
  </fallback_sequence>
</recursive_constraint_validation>
```

**Add After `</fallback_sequence>`:**
```xml
<external_validation priority="MANDATORY">
  <policy>Fail-Closed Validation Required</policy>
  <validator>scripts/validate_bullets.py</validator>
  <enforcement>
    Before delivering ANY bullet output, validation MUST pass.
    If validation fails (exit code 1), STOP and fix violations.
    Do NOT deliver output with failing guardrails.
  </enforcement>
  <compliance_tracking>
    Results automatically logged to docs/governance/compliance_logs.json
    Platform-specific thresholds: Platform 2 &lt; 50%, Platform 3 &lt; 40%
  </compliance_tracking>
</external_validation>
```

**Problem 2: generate-bullets.md Uses "Fail-Open" Language**

**File:** `.agent/workflows/generate-bullets.md`
**Location:** Line 117 (Step 4 section header)

**Current State:**
```markdown
**Realistic Expectations:**
- **Compliance Ceiling:** ~60-80% for prompt-based guardrails.
- **Fail-Open Policy:** Paste output into `scripts/validate_bullets.py` locally for external verification.
- **Visible Proof:** If the "Proof of Work" JSON is missing, reject the output.
```

**Change To:**
```markdown
**Realistic Expectations:**
- **Compliance Ceiling:** ~60-80% for prompt-based guardrails.
- **Fail-Closed Validation Required:** Output MUST pass `scripts/validate_bullets.py` validation before delivery.
- **Enforcement Policy:** Validation failures STOP delivery. Fix violations, then re-validate.
- **Visible Proof:** If the "Proof of Work" JSON is missing, reject the output.
```

**Add New Step 4.5:**
```markdown
### Step 4.5: External Validation (MANDATORY)

**‚ö†Ô∏è ACTION REQUIRED:** Before delivering final output, run external validation:

```bash
# Copy output to file
cat output.txt | python scripts/validate_bullets.py
```

**If validation FAILS:**
1. Review failed guardrails in validation report
2. Fix violations in output
3. Re-run validation until exit code 0
4. ONLY THEN deliver to user

**If validation PASSES:**
- Compliance logged automatically to docs/governance/compliance_logs.json
- Proceed with delivery
```

**Validation:**
| File | Change | Status |
|------|--------|--------|
| PROJECT-INSTRUCTIONS.md | G40 `<external_validation>` block added | [ ] |
| generate-bullets.md | "Fail-Open" ‚Üí "Fail-Closed" | [ ] |
| generate-bullets.md | Step 4.5 added with validator instructions | [ ] |

---

### Item 10: Add User-Readable Verification Checklist

**Status:** MEDIUM PRIORITY - v9.3.6 concept, never implemented

**Rationale:**
- validate_bullets.py is developer-focused (exit codes, technical output)
- Users need simple checklist for manual spot-checks
- Complements automated validation (human verification layer)

**Create New File:** `docs/checklists/bullet-verification-checklist.md`

**Content Structure:**
1. **Pre-Generation Checklist** (before starting)
2. **Budget Table Verification** (after Stage 1)
3. **Per-Position Verification** (after each position generated)
4. **Final Output Verification** (before accepting)

**Extract From:** `optimization-tools/bullet-optimizer/bo_output-validator.md`
- Convert technical FAIL conditions to user-friendly "Check if..." statements
- Use checkboxes for user to mark
- Provide examples of violations

**Update Platform Guides:**
- `docs/platform-implementations/v9.3.7-platform-2-claude-project.md` (line ~115)
- `docs/platform-implementations/v9.3.7-platform-3-google-ai-studio.md` (line ~115)
- Add reference: "Optional: Use docs/checklists/bullet-verification-checklist.md for manual verification"

**Validation:**
| File | Status |
|------|--------|
| docs/checklists/bullet-verification-checklist.md | [ ] Created |
| v9.3.7-platform-2-claude-project.md | [ ] Updated |
| v9.3.7-platform-3-google-ai-studio.md | [ ] Updated |

---

### Item 11: Verify Platform 2 Token Optimization

**Status:** LOW PRIORITY - v9.3.6 concept verification

**Rationale:**
- v9.3.6 wanted < 200 line prompt for Claude Project
- v9.3.7 Platform 2 guide may still be too verbose
- Token efficiency = higher attention weight per instruction

**File to Review:** `docs/platform-implementations/v9.3.7-platform-2-claude-project.md`

**Verification Steps:**
1. Count required files for Project 2 (Should-I-Apply)
2. Verify essential files only (no redundant modules)
3. Check system prompt length in guide (should be < 500 words)
4. Confirm minimized guardrail set (G1, G8, G12, G24, G29, G40 only)

**Metrics:**
| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Required files (Project 2) | < 20 | [ ] | [ ] |
| System prompt words | < 500 | [ ] | [ ] |
| Guardrail count | 6 core | [ ] | [ ] |
| Instructions clarity | Concise | [ ] | [ ] |

---

## Item 12: Update Knowledge Graph with v9.3.7.1 Patterns

**Status:** REQUIRED - Capture new enforcement patterns

**Patterns Discovered (from v9.3.7.1 verification):**
1. **Pipeline Integration Pattern** - Auto-invoke validators from generators
2. **Fail-Closed Enforcement** - Structural validation before output delivery
3. **Probabilistic Enforcement** - Acknowledge ~60-80% compliance ceiling
4. **Compliance Tracking** - Monitor enforcement drift over time

**Implementation:**

1. **Create Lesson-Learned Document** (if not already documented):
   - File: `docs/lessons-learned/enforcement/v9.3.7.1-verification-enhancements.md`
   - Content: Problem (infrastructure gaps), Root Cause (post-implementation discovery), Solution (Items 7-11), Lessons

2. **Run Knowledge Graph Update:**
   ```bash
   /update-knowledge-graph --auto
   ```

3. **Verify New Entries Created:**
   - `docs/knowledge/patterns.md` - Pipeline Integration, Fail-Closed Enforcement
   - `docs/knowledge/gotchas.md` - Probabilistic Enforcement Ceiling (if new)

4. **Update Cross-References:**
   - Link lesson-learned to knowledge entries
   - Link knowledge entries back to implementation plan

**Files Affected:**
- NEW: `docs/lessons-learned/enforcement/v9.3.7.1-verification-enhancements.md`
- UPDATE: `docs/knowledge/patterns.md`
- UPDATE: `docs/knowledge/gotchas.md` (optional)

**Validation:**
| File | Status |
|------|--------|
| Lesson created | [ ] |
| Knowledge entries created/updated | [ ] |
| Bidirectional links verified | [ ] |
| `/enforce-shadow-sync --auto` passes | [ ] |

---

## Shadow Sync Requirements

Files requiring three-tier sync:
- `PROJECT-INSTRUCTIONS.md` (GOLD MASTER) - G40 update
- `Project-GUI-Instructions.md` (ENTRYPOINT) - Verify sync
- `.agent/workflows/generate-bullets.md` (WORKFLOW) - Fail-closed update

**Action:** Run `/enforce-shadow-sync --auto` after Items 9-11 complete.

**Knowledge Graph Integration:**
- Run `/update-knowledge-graph --auto` after Item 12 (lesson creation)

---

## Final Reconciliation Table

| Item | Priority | Status | Validation |
|------|----------|--------|------------|
| 7: Integrate compliance_tracker.py | HIGH | [ ] | Pipeline functional |
| 8: Verify template completeness | HIGH | [ ] | All 3 templates verified |
| 9: Add fail-closed language | CRITICAL | [ ] | G40 + workflow updated |
| 10: User verification checklist | MEDIUM | [ ] | Checklist created |
| 11: Platform 2 optimization | LOW | [ ] | Token metrics verified |
| 12: Update knowledge graph | REQUIRED | [ ] | Patterns documented |
| Shadow Sync Verification | REQUIRED | [ ] | 3-tier consistency |
| Knowledge Graph Sync | REQUIRED | [ ] | Bidirectional links |

---

## Success Criteria

**All items complete when:**
- [ ] compliance_tracker.py auto-invoked by validate_bullets.py
- [ ] compliance_logs.json populated with test run
- [ ] All 3 workflow templates verified complete
- [ ] G40 has `<external_validation>` block
- [ ] generate-bullets.md uses "Fail-Closed" language
- [ ] generate-bullets.md has Step 4.5 (external validation)
- [ ] docs/checklists/bullet-verification-checklist.md created
- [ ] Platform 2/3 guides reference user checklist
- [ ] Platform 2 file list verified minimal
- [ ] `/enforce-shadow-sync --auto` passes

---

## Test Cases

### Test 1: Pipeline Integration
**Input:** Run validate_bullets.py with sample output
**Expected:** compliance_logs.json created with timestamp, platform, results, rate
**Status:** [ ]

### Test 2: Template Completeness
**Input:** Review all 3 workflow templates
**Expected:** All stages/layers documented with examples
**Status:** [ ]

### Test 3: Fail-Closed Enforcement
**Input:** Generate bullets, fail validation
**Expected:** Output rejected, user prompted to fix violations
**Status:** [ ]

### Test 4: User Checklist
**Input:** User follows bullet-verification-checklist.md
**Expected:** User can manually verify all 8 critical checks
**Status:** [ ]

---

## Related Documentation

- **Parent Plan:** [v9.3.7-guardrail-enforcement-fix.md](v9.3.7-guardrail-enforcement-fix.md)
- **Issue Tracker:** [issue-98](../issues/issue-98/)
- **GitHub Issue:** [#98](https://github.com/technomensch/optimize-my-resume/issues/98)
- **Analysis Source:** `/Users/mkaplan/.claude/plans/proud-munching-storm.md`

---

**CRITICAL TERMINATION:**
*"DOCUMENTATION COMPLETE. I have ENGAGED the implementation freeze. Read this plan and say 'Execute Item 7' when you have reviewed and approved the logic. I will not proceed until then."*

**STOP.**
