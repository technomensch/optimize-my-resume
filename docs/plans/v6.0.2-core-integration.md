# v6.0.2 Core Integration - Mode Enhancements

**Version:** 6.0.2 (Part 2 of 4)
**Branch:** `v6.0.2-core-integration`
**Token Budget:** 64,000 tokens (within 200K limit)
**Status:** Ready for Implementation

---

## Overview

This phase integrates the foundational schemas from v6.0.1 into the existing mode workflows. It's where the system starts generating v2.0 job histories and performing evidence-based gap analysis.

**Goal:** Surgically enhance Mode 1 and Mode 3 to use v6.0.1 schemas without breaking existing functionality.

**Strategy:** Modify existing files minimally - add references to v6.0.1 modules, preserve all current logic.

---

## Prerequisites

**Must have v6.0.1 completed:**
- ✅ `shared/schemas/job-history-v2.0-schema.json` exists
- ✅ `shared/modules/skills-categorizer.md` exists
- ✅ `shared/modules/jd-processing.md` exists

---

## Scope

### ✅ Included in v6.0.2

1. **Evidence Matcher Module** - Links parsed JD to job history with citations
2. **Mode 1 Enhancement** - Generate job history v2.0 format
3. **Mode 3 Enhancement** - Use 17-point parser + evidence matching + blocking gates

### ❌ Not Included (Deferred to Later Phases)

- Entry point router (v6.0.3)
- Incremental updates (v6.0.3)
- Professional summary generation (v6.0.4)
- Re-comparison workflow (v6.0.3)

---

## Files to Create (1 New File)

### File 1: `/shared/modules/evidence-matching.md`

**Purpose:** Match JD requirements against job history with evidence citations and diff generation

**Size:** ~200 lines

**Content Structure:**
```xml
<evidence_matcher>
  <purpose>
    For EVERY requirement in the parsed JD, find evidence in job history and cite sources.
    Generate requirement-by-requirement gap analysis with evidence citations.
  </purpose>

  <matching_logic>
    <step_1_requirement_extraction>
      Extract all requirements from parsed JD:

      requirements = [
        ...jd.skills_needed.map(r => ({req: r, subcategory: "Skills Needed", importance: "Required"})),
        ...jd.skills_wanted.map(r => ({req: r, subcategory: "Skills Wanted", importance: "Preferred"})),
        ...jd.soft_skills_needed.map(r => ({req: r, subcategory: "Soft Skills Needed", importance: "Required"})),
        ...jd.soft_skills_wanted.map(r => ({req: r, subcategory: "Soft Skills Wanted", importance: "Preferred"})),
        ...jd.qualifications_needed.map(r => ({req: r, subcategory: "Qualifications Needed", importance: "Required"})),
        ...jd.certifications_needed.map(r => ({req: r, subcategory: "Certifications Needed", importance: "Required"})),
        ...jd.job_responsibilities.map(r => ({req: r, subcategory: "Responsibility", importance: "Required"}))
      ]
    </step_1_requirement_extraction>

    <step_2_evidence_search>
      For EACH requirement:

      1. **Exact Match Search:**
         - Search job history for exact keyword
         - Check: hard_skills_demonstrated, soft_skills_demonstrated, certifications
         - If found → status = "Matched"

      2. **Semantic Match Search:**
         - Search for related concepts (e.g., "Python" matches "developed ETL pipelines")
         - Check: core_responsibilities, key_achievements
         - If found → status = "Partial"

      3. **Missing:**
         - No evidence found in any section
         - status = "Missing"
    </step_2_evidence_search>

    <step_3_citation_formatting>
      For each evidence found:

      {
        "content": "Direct quote from resume (exact text from achievement/responsibility)",
        "source": "Company | Job Title",
        "source_type": "achievement" | "responsibility" | "skill"
      }

      FORMATTING RULES (Opus Decision 5):
      - Same company, multiple roles → Show each role with dates
        Example: "Google | PM (2018-2020)" and "Google | Lead PM (2022-2024)"
      - Contractor → "Accenture (Client: DHS) | Analyst"
      - Freelance → "Consultant | Freelance (5 clients)"
      - NO prefixes like "Resume -", "at", "Candidate -"
      - Format: "Company | Job Title (dates if multiple roles at same company)"
    </step_3_citation_formatting>

    <step_4_gap_rationale>
      For each requirement, explain the gap:

      MATCHED:
        "Strong evidence across multiple roles"
        "Exact keyword match in skills section"

      PARTIAL:
        "Resume shows related experience (statistical analysis) but not explicit ML frameworks"
        "Demonstrated leadership but not at required scale (led team of 5, JD requires 10+)"

      MISSING:
        "No evidence of [SKILL] found in job history"
        "Experience gap: JD requires [X], resume shows [Y]"
    </step_4_gap_rationale>
  </matching_logic>

  <evidence_based_vs_keyword_check>
    <!-- Opus Decision 3: Two-part check -->

    For EACH requirement:

    1. **Evidence Match:** Did the candidate DEMONSTRATE this skill?
       - Look for achievements, responsibilities, projects
       - This is the PRIMARY assessment

    2. **Keyword Check:** Does the resume EXPLICITLY mention this keyword?
       - Check if keyword appears in skills section or summary
       - This is SECONDARY (for ATS optimization)

    OUTPUT:
    - IF evidence found AND keyword present → [MATCHED]
    - IF evidence found BUT keyword missing → [PARTIAL] with keyword recommendation
    - IF no evidence → [MISSING]

    Example:
    ```
    [MATCHED] Agile
      Evidence: "Led sprint planning and backlog grooming sessions" (TechCorp | PM)
      Keyword status: ✓ "Agile" appears in skills section

    [PARTIAL] Agile
      Evidence: "Managed iterative product development cycles" (StartupCo | PM)
      Gap: Keyword "Agile" not explicitly listed - add to skills section for ATS
    ```
  </evidence_based_vs_keyword_check>

  <color_coded_output>
    KEY: [MATCHED] (Green) | [PARTIAL] (Yellow) | [MISSING] (Red)

    [HARD SKILLS - REQUIRED]

    [MATCHED] Python
      Evidence:
      - "Developed ETL pipelines using Python and Pandas"
        → TechCorp | Data Engineer (2020-2022)
      - "Automated workflows with Python scripts (saved 20 hrs/week)"
        → StartupCo | Senior Analyst (2018-2020)

    [PARTIAL] Machine Learning
      Evidence:
      - "Applied statistical models to forecast trends"
        → StartupCo | Data Analyst (2017-2018)
      Gap: Resume shows statistical analysis but not explicit ML frameworks (scikit-learn, TensorFlow)
      Recommendation: If you have ML experience, add specific framework keywords

    [MISSING] Kubernetes
      Evidence: None found
      Gap: No container orchestration experience mentioned
      Recommendation: Not strategic to apply unless you're willing to learn Kubernetes

    SORTING ORDER:
    - Matched items first
    - Partial items second
    - Missing items last
  </color_coded_output>

  <diff_generation>
    <!-- For re-comparison workflow (v6.0.3) -->

    When comparing CURRENT job history to PREVIOUS comparison:

    {
      "improvements": [
        {
          "requirement": "Salesforce",
          "previous_status": "Missing",
          "current_status": "Matched",
          "new_evidence": "Implemented Salesforce integration (Acme Corp | PM)"
        }
      ],
      "no_change": ["SQL", "Agile", "Leadership"],
      "score_delta": "+9 points (72% → 81%)"
    }

    OUTPUT:
    ```
    ## Changes Since Last Comparison

    ### Improvements
    - [MISSING → MATCHED] Salesforce: Now matched from your new position at Acme Corp
    - [PARTIAL → MATCHED] Python: Updated context with new project details

    ### No Change
    - [MATCHED] SQL, Agile, Leadership
    - [MISSING] Kubernetes (still not in your history)

    ### Overall Score: 72% → 81% (+9 points)
    ```
  </diff_generation>

  <output_schema>
    {
      "requirement_analysis": [
        {
          "requirement": "Python programming",
          "subcategory": "Skills Needed",
          "importance": "Required",
          "status": "Matched",
          "evidence": [
            {
              "content": "Developed ETL pipelines using Python and Pandas",
              "source": "TechCorp | Data Engineer",
              "source_type": "achievement"
            }
          ],
          "gap_rationale": "Strong evidence across multiple roles",
          "keyword_present": true
        }
      ],
      "summary": {
        "matched_count": 12,
        "partial_count": 5,
        "missing_count": 3,
        "match_score": 75
      }
    }
  </output_schema>
</evidence_matcher>
```

**Key Features (from Opus review):**
- Requirement-by-requirement analysis (not aggregated)
- Evidence citations with source formatting
- Two-part check (evidence + keyword)
- Diff generation for re-comparison
- Color-coded output with sorting

---

## Files to Modify (3 Files - Surgical Changes)

### Modification 1: `PROJECT-INSTRUCTIONS.md`

**Changes:**

**Location 1: After line 15 (Mode detection section)**
```xml
<!-- ADD THIS SECTION -->
<job_history_schema_version>
  The system now uses Job History Schema v2.0 (as of v6.0.2).

  Key changes from v1.0:
  - hard_skills_demonstrated and soft_skills_demonstrated (separated)
  - education field added
  - certifications array added
  - professional_summary per role added

  When generating job history, use the schema defined in:
  shared/schemas/job-history-v2.0-schema.json
</job_history_schema_version>
```

**Location 2: Lines 40-120 (Mode 1 job history creation section)**
```xml
<!-- REPLACE the job history creation instructions -->
<job_history_creation>
  After extracting resume data, generate job history in v2.0 format:

  FOR EACH position in resume:
    1. Extract metadata (job_title, company, dates)
    2. Extract core_responsibilities (3-5 bullets)
    3. Extract key_achievements (3-5 bullets with metrics)
    4. Categorize skills using shared/modules/skills-categorizer.md:
       - Run each skill through categorization logic
       - Separate into hard_skills_demonstrated and soft_skills_demonstrated
    5. Extract education (if mentioned in context of this role)
    6. Extract certifications (if mentioned in context of this role)
    7. Extract tools_technologies (granular list)
    8. Extract impact_metrics (quantified results)
    9. Extract industry_domain
    10. Extract team_scope
    11. Generate professional_summary for this role:
        - 2-3 sentences summarizing role scope
        - Key achievements and metrics
        - 2-3 hard skills demonstrated
        - 1-2 soft skills demonstrated

  SAVE to: claude_generated_job_history_summaries_v2.txt
  FORMAT: Plain text with XML-like structure (see schema for details)
</job_history_creation>
```

**Location 3: After Mode 1 completion (new section after line 120)**
```xml
<!-- ADD THIS SECTION -->
<mode_1_completion_next_steps>
  After job history v2.0 is generated and saved, present next steps:

  "✅ Analysis complete! Your job history has been saved.

  Next steps - What would you like to do?
  1. Optimize specific resume bullets (Mode 2)
  2. Check fit for a job description (Mode 3)
  3. Export job history for review

  Just let me know, or paste a job description to start Mode 3!"
</mode_1_completion_next_steps>
```

**Location 4: Line ~800 (version number)**
```xml
<!-- UPDATE version -->
<version>6.0.2</version>
```

---

### Modification 2: `modes/mode-3-jd-comparison.md`

**Changes:**

**Location 1: Lines 80-120 (JD extraction section)**
```xml
<!-- REPLACE current JD extraction with 17-point parser -->
<jd_parsing>
  Use the 17-point parsing schema from shared/modules/jd-processing.md

  Extract all 17 fields:
  - company, job_title, location, work_lifestyle
  - remote_restrictions, employee_type, travel_required, clearance
  - salary_range, required_experience, required_education, job_responsibilities
  - skills_needed, skills_wanted (HARD skills - required/preferred)
  - soft_skills_needed, soft_skills_wanted (SOFT skills - required/preferred)
  - qualifications_needed, qualifications_wanted
  - certifications_needed, certifications_wanted

  IMPORTANT: Use skills-categorizer.md to separate hard vs soft skills
</jd_parsing>
```

**Location 2: After line 150 (add requirement-by-requirement gap tracking)**
```xml
<!-- ADD THIS SECTION -->
<requirement_by_requirement_gap_analysis>
  Use shared/modules/evidence-matching.md to analyze EVERY requirement.

  For EACH requirement:
  1. Search job history v2.0 for evidence
  2. Determine status (Matched/Partial/Missing)
  3. Collect evidence citations with sources
  4. Provide gap rationale

  OUTPUT using color-coded format:
  - KEY legend at top
  - Section headers ([HARD SKILLS - REQUIRED], etc.)
  - Matched → Partial → Missing sorting within each section
  - Evidence citations in "Company | Job Title" format
</requirement_by_requirement_gap_analysis>
```

**Location 3: After line 220 (add blocking gates)**
```xml
<!-- ADD THIS SECTION -->
<blocking_gates>
  After gap analysis, check blocking gates (Opus Decision 2: Soft block with warning):

  <gate_1_hard_skill_deficit>
    IF count(Missing Hard Skills) > count(Matched Hard Skills):
      DISPLAY WARNING:
      "⚠ WARNING: Poor Job Fit Detected

      Hard Skills Required by JD:
        [MATCHED] {list matched skills}
        [MISSING] {list missing skills}

      You are missing {X} of {Y} required hard skills.

      Proceeding will use tokens to generate recommendations that are unlikely
      to be useful. This is not advised.

      Do you want to proceed anyway? (yes/no)"

      IF user says "no":
        STOP analysis, save tokens
      IF user says "yes":
        CONTINUE to recommendations (user accepted risk)
  </gate_1_hard_skill_deficit>

  <gate_2_low_match_score>
    IF match_score < 30:
      DISPLAY WARNING:
      "⚠ LOW MATCH SCORE DETECTED (<30)

      Final Match Score: {score}/100

      Based on the analysis, this position has significant gaps compared to your profile.
      Optimization is unlikely to bridge this gap effectively.

      Recommendation: Focus on roles with 50+ match scores where optimization can be strategic.

      Do you want to proceed anyway? (yes/no)"

      IF user says "no":
        STOP analysis
      IF user says "yes":
        CONTINUE to recommendations
  </gate_2_low_match_score>

  <gate_3_location_mismatch>
    <!-- KEEP EXISTING v5.1 logic from ADD_REMOTE_WORK_LOGIC.md -->
    <!-- This gate already exists, don't modify -->
  </gate_3_location_mismatch>
</blocking_gates>
```

**Location 4: After line 280 (add per-JD summary option placeholder)**
```xml
<!-- ADD THIS SECTION (basic version, full implementation in v6.0.4) -->
<per_jd_summary_placeholder>
  After gap analysis completes, if match_score >= 50:
    OFFER: "Would you like me to generate a customized professional summary for this JD?"

    IF yes:
      NOTE: "Per-JD summary generation will be implemented in v6.0.4.
             For now, use your master summary from job history."
</per_jd_summary_placeholder>
```

---

### Modification 3: `modes/mode-2-bullet-optimization.md`

**Changes:**

**Location 1: Line ~30 (job history file reference)**
```xml
<!-- UPDATE to support both v1.0 and v2.0 -->
<job_history_loading>
  <!-- Backward compatibility - check v2.0 first, fallback to v1.0 -->

  IF file exists: claude_generated_job_history_summaries_v2.txt:
    LOAD v2.0 format
    USE hard_skills_demonstrated and soft_skills_demonstrated arrays
  ELSE IF file exists: claude_generated_job_history_summaries.txt:
    LOAD v1.0 format
    USE skills_demonstrated array (combined hard/soft)
    RECOMMEND: "I see you have v1.0 job history. Consider re-running Mode 1 to upgrade to v2.0 for better keyword matching with separated hard/soft skills."
  ELSE:
    ERROR: "No job history found. Please run Mode 1 first to analyze your resume."
</job_history_loading>
```

**Location 2: Line ~60 (skills reference for keyword insertion)**
```xml
<!-- UPDATE to use v2.0 skills arrays -->
<keyword_insertion_logic>
  IF using v2.0 job history:
    - Use hard_skills_demonstrated for technical keyword insertion
    - Use soft_skills_demonstrated for behavioral keyword insertion
  ELSE IF using v1.0 job history:
    - Use skills_demonstrated array (combined)
</keyword_insertion_logic>
```

---

## Implementation Steps

### Step 1: Create Evidence Matcher Module
```bash
# Create evidence-matching.md in shared/modules/
# Write matching logic with citation formatting
```

**Validation:**
- Test with sample JD + job history
- Verify all requirements analyzed
- Check evidence citation format ("Company | Title")

---

### Step 2: Modify PROJECT-INSTRUCTIONS.md
```bash
# Read current file
# Make 4 surgical additions (line 15, 40-120, 120, 800)
# Preserve all existing logic
```

**Validation:**
- Mode 1 still works for standalone analysis
- v2.0 job history generation triggered
- Next steps message appears after completion

---

### Step 3: Modify mode-3-jd-comparison.md
```bash
# Read current file
# Make 4 surgical additions (80-120, 150, 220, 280)
# Preserve v5.1 location blocking gate
```

**Validation:**
- 17-point JD parsing works
- Evidence matching produces citations
- Blocking gates fire correctly
- v5.1 location logic still works

---

### Step 4: Modify mode-2-bullet-optimization.md
```bash
# Read current file
# Make 2 surgical additions (line 30, 60)
# Ensure backward compatibility
```

**Validation:**
- Mode 2 works with v2.0 job history
- Mode 2 falls back to v1.0 if v2.0 not found
- Upgrade recommendation shown for v1.0 users

---

## Testing Checklist

### Mode 1 Enhancement Tests

- [ ] Mode 1 generates job history v2.0 with all 12 sections
- [ ] Professional summary generated for each role
- [ ] Hard/soft skills separated correctly
- [ ] Education extracted (if present)
- [ ] Certifications extracted (if present)
- [ ] "Next Steps" message appears after completion
- [ ] v2.0 file saved to correct location

### Mode 3 Enhancement Tests

- [ ] 17-point JD parsing extracts all fields
- [ ] Requirement-by-requirement gap analysis works
- [ ] Evidence citations formatted as "Company | Title"
- [ ] Color-coded output displayed correctly
- [ ] Matched/Partial/Missing sorting works
- [ ] Gate 1 (hard skill deficit) fires correctly
- [ ] Gate 2 (low match score) fires correctly
- [ ] Gate 3 (location mismatch) still works from v5.1
- [ ] User can override gates with "yes/no"

### Mode 2 Backward Compatibility Tests

- [ ] Mode 2 loads v2.0 job history successfully
- [ ] Mode 2 falls back to v1.0 if v2.0 not found
- [ ] Upgrade recommendation shown for v1.0 users
- [ ] Keyword insertion uses hard/soft skills correctly (v2.0)
- [ ] Keyword insertion works with combined skills (v1.0)

### Evidence Matcher Tests

- [ ] Exact match: "Python" in hard_skills → status = "Matched"
- [ ] Semantic match: "developed ETL pipelines" → status = "Partial" for "Python"
- [ ] Missing: No evidence found → status = "Missing"
- [ ] Citations include source: "TechCorp | Data Engineer"
- [ ] Multiple roles at same company → separate citations with dates
- [ ] Contractor format: "Accenture (Client: DHS) | Analyst"

---

## Dependencies

**Requires:**
- ✅ v6.0.1 (all 3 files must exist)

**Required by:**
- v6.0.3 (router will detect v2.0 job history)
- v6.0.4 (summary generator will read v2.0 job history)

---

## Success Criteria

v6.0.2 is successful if:

1. ✅ Mode 1 generates job history v2.0 (100% of new analyses)
2. ✅ Mode 3 uses 17-point JD parsing (100% of JD comparisons)
3. ✅ Evidence matching produces citations for all requirements
4. ✅ Blocking gates fire correctly with soft blocking (allow override)
5. ✅ Mode 2 backward compatible with v1.0 job histories
6. ✅ All tests pass without errors
7. ✅ No regressions in existing functionality

---

## Issues & Mitigations

### Issue 1: Evidence Citation Source Inconsistency (from Opus review)

**Problem:** Job histories might have inconsistent company/title formats.

**Mitigation:**
- Standardize format during job history creation (Mode 1)
- Enforce "Company | Job Title" in v2.0 schema
- Post-processing in evidence matcher to normalize

### Issue 2: Blocking Gates Too Aggressive

**Problem:** Gates might block users who are close matches.

**Mitigation:**
- Soft blocking with override option (Opus Decision 2)
- Clear warning message explaining why blocking
- User decides whether to proceed (yes/no)

### Issue 3: v1.0 to v2.0 Migration Confusion

**Problem:** Users with v1.0 job history might not know to upgrade.

**Mitigation:**
- Mode 2 shows clear upgrade recommendation
- Explains benefits of v2.0 (better keyword matching)
- Doesn't force upgrade (backward compatible)

---

## Next Steps

**After v6.0.2 Completes:**

1. **Git Workflow:**
   ```bash
   git checkout -b v6.0.2-core-integration
   git add shared/modules/ PROJECT-INSTRUCTIONS.md modes/
   git commit -m "feat(v6.0.2): integrate v2.0 schema into modes 1 & 3, add evidence matching"
   git push origin v6.0.2-core-integration
   ```

2. **Testing:**
   - Run full end-to-end test: New resume → Mode 1 → Mode 3 with JD
   - Verify v2.0 job history generated
   - Verify 17-point JD parsing works
   - Verify blocking gates fire

3. **Proceed to v6.0.3:**
   - Build entry point router
   - Add incremental update handler
   - Add re-comparison workflow
   - See `/docs/plans/v6.0.3-router-workflows.md`

---

**Plan Created:** 2025-12-28
**Token Budget:** 64,000 tokens (estimated)
**Dependencies:** v6.0.1 (required)
**Next Phase:** v6.0.3 Router & Workflows
