# v6.0.3 Router & Workflows - Entry Point & Additional Features

**Version:** 6.0.3 (Part 3 of 4)
**Branch:** `v6.0.3-router-workflows`
**Token Budget:** 49,000 tokens (within 200K limit)
**Status:** Ready for Implementation

---

## Overview

This phase adds the entry point router for auto-detecting user intent and two additional workflows: incremental position updates and JD re-comparison.

**Goal:** Create seamless user experience with intelligent routing and support for ongoing resume maintenance.

**Strategy:** Build router module + integrate incremental update logic into Mode 3 for re-comparison.

---

## Prerequisites

**Must have v6.0.2 completed:**
- ✅ Mode 1 generates job history v2.0
- ✅ Mode 3 uses 17-point JD parsing
- ✅ Evidence matcher module exists

---

## Scope

### ✅ Included in v6.0.3

1. **Entry Point Router** - Auto-detect user state + confirm before executing
2. **Incremental Updates** - Add/edit/remove positions without full re-analysis
3. **JD Re-Comparison** - Re-run comparison with updated job history + diff output

### ❌ Not Included (Deferred to v6.0.4)

- Professional summary generation (master + per-JD)
- Summary customization logic
- Documentation updates
- Multi-track career support (removed from v6.0 scope per Opus Decision 1a)

---

## Files to Create (1 New File)

### File 1: `/shared/modules/workflow-router.md`

**Purpose:** Detect user intent and route to appropriate mode with confirmation

**Size:** ~300 lines

**Content Structure:**
```xml
<workflow_router>
  <purpose>
    Analyze user input and context to determine which workflow to execute.
    Always confirm with user before proceeding (hybrid auto-detect + confirmation).
  </purpose>

  <context_detection>
    <check_job_history>
      IF file exists: claude_generated_job_history_summaries_v2.txt
      AND file is not empty
      THEN state.hasJobHistory = true
      ELSE state.hasJobHistory = false
    </check_job_history>

    <check_jd_provided>
      <!-- JD Detection Heuristics (from Opus review Issue #4) -->

      JD_INDICATORS = [
        "Job Description:", "JD:", "Role:", "Requirements:",
        "Apply for:", "Position at", "Responsibilities:",
        "Qualifications:", "We are looking for"
      ]

      JD_VALIDATION_HEURISTICS = {
        length: text.length > 200 && text.length < 5000,
        has_keywords: text includes ("requirements" OR "qualifications" OR "responsibilities"),
        has_structure: text includes (bullet points OR numbered lists),
        has_company: text mentions company name or role title
      }

      IF user message matches JD_INDICATORS:
        IF JD_VALIDATION_HEURISTICS pass:
          state.hasJD = true
          state.jdConfidence = "high"
        ELSE:
          state.hasJD = "maybe"
          state.jdConfidence = "low"
          ASK USER: "This looks like a job description, but I'm not certain. Is this a JD you want to analyze?"
    </check_jd_provided>

    <check_resume_uploaded>
      IF user uploads file (PDF/DOCX/TXT):
        state.hasResume = true
      OR IF user pastes text > 300 words:
        state.hasResume = true
    </check_resume_uploaded>

    <check_override_commands>
      <!-- From Issue #9: Router doesn't handle resume updates -->

      OVERRIDE_KEYWORDS = {
        "re-analyze": Force Mode 1,
        "start over": Delete v2.0 file + Force Mode 1,
        "start fresh": Delete v2.0 file + Force Mode 1,
        "update job history": Force Mode 1 (append mode),
        "add position": Incremental update mode,
        "remove position": Incremental update mode,
        "edit position": Incremental update mode
      }

      IF user message matches OVERRIDE_KEYWORDS:
        state.forceMode = detected_mode
    </check_override_commands>
  </context_detection>

  <routing_scenarios>
    <!-- 5 core scenarios + 3 additional workflows -->

    <scenario_1_new_user priority="1">
      <condition>state.hasResume = true AND state.hasJobHistory = false</condition>
      <route>Mode 1 (Full Analysis)</route>
      <confirmation>
        "I detected a new resume upload. I'll perform a comprehensive resume analysis
        and create your job history profile.

        After analysis, you can:
        - Optimize specific bullets (Mode 2)
        - Check fit for a job description (Mode 3)

        Proceed with full analysis?"
      </confirmation>
      <on_confirm>Execute Mode 1</on_confirm>
      <on_decline>Ask "What would you like me to do instead?"</on_decline>
    </scenario_1_new_user>

    <scenario_2_jd_comparison priority="2">
      <condition>state.hasJobHistory = true AND state.hasJD = true</condition>
      <route>Mode 3 (JD Comparison)</route>
      <confirmation>
        "I detected your job history and a job description. I'll analyze your fit
        for this role using the 17-point gap analysis system.

        This will compare your profile against:
        - Required/preferred hard skills
        - Required/preferred soft skills
        - Experience, education, certifications
        - Location/remote work compatibility

        Proceed with JD fit analysis?"
      </confirmation>
      <on_confirm>Execute Mode 3</on_confirm>
      <on_decline>Ask "Would you like to do something else instead?"</on_decline>
    </scenario_2_jd_comparison>

    <scenario_3_bullet_optimization priority="3">
      <condition>state.hasJobHistory = true AND user mentions ("bullet", "optimize", "improve wording")</condition>
      <route>Mode 2 (Bullet Optimization)</route>
      <confirmation>
        "I'll optimize your resume bullets using your job history as context.

        Which bullets would you like me to improve? You can:
        - Paste specific bullets to optimize
        - Upload your current resume for bulk optimization

        Proceed?"
      </confirmation>
      <on_confirm>Execute Mode 2</on_confirm>
    </scenario_3_bullet_optimization>

    <scenario_4_ambiguous priority="4">
      <condition>state.hasJobHistory = true AND state.hasJD = false AND no override detected</condition>
      <route>None (Ask user)</route>
      <clarification>
        "I see you have a job history on file. What would you like to do?

        1. Check fit for a specific job description (Mode 3)
        2. Optimize resume bullets (Mode 2)
        3. Re-analyze my resume with updated info (Mode 1)
        4. Add/edit a position in my job history

        Please select 1-4 or describe what you need."
      </clarification>
    </scenario_4_ambiguous>

    <scenario_5_first_interaction priority="5">
      <condition>state.hasResume = false AND state.hasJobHistory = false</condition>
      <route>None (Explain system)</route>
      <welcome>
        "Welcome to the Resume Analyzer & Optimizer!

        I can help you:
        1. **Analyze your resume** - Get comprehensive feedback (Mode 1)
        2. **Optimize bullets** - Improve specific resume lines (Mode 2)
        3. **Check job fit** - Compare your resume to a job description (Mode 3)

        To get started, please upload your resume (PDF, DOCX, or paste text).

        If you have a specific job description you're targeting, include that too!

        Note: Your job history is saved to files in this project. If you close this
        session, your data persists but conversation context is lost. Start a new
        session anytime - I'll pick up where you left off using your saved files."
      </welcome>
    </scenario_5_first_interaction>

    <scenario_6_incremental_update priority="6">
      <condition>user message matches ("add position", "edit position", "remove position")</condition>
      <route>Incremental Update Handler</route>
      <confirmation>
        "I'll help you update your job history.

        What would you like to do?
        1. Add a new position
        2. Edit an existing position
        3. Remove a position

        Please select 1-3 or describe the change."
      </confirmation>
      <on_confirm>Execute incremental update logic (see below)</on_confirm>
    </scenario_6_incremental_update>

    <scenario_7_re_comparison priority="7">
      <condition>user message matches ("compare again", "re-run", "updated history") AND state.hasJobHistory = true</condition>
      <route>JD Re-Comparison Handler</route>
      <confirmation>
        "I'll re-run the JD comparison with your updated job history.

        Please paste the job description you want to re-analyze."
      </confirmation>
      <on_confirm>Execute re-comparison logic (see below)</on_confirm>
    </scenario_7_re_comparison>

    <scenario_8_ambiguous_input priority="8">
      <!-- From Opus Decision 7: Two-step guided conversation -->

      <condition>Cannot determine intent from input</condition>
      <route>None (Clarify with user)</route>
      <step_1_confirm_assumption>
        "This looks like [DETECTED_TYPE]. Is that correct? (yes/no)"
      </step_1_confirm_assumption>
      <step_2a_if_yes>
        "Would you like me to [ACTION]? (yes/no)"
      </step_2a_if_yes>
      <step_2b_if_no>
        "Got it. Is this:
         1. Part of a resume (I'll analyze it)
         2. Part of a JD (I'll compare against your job history)
         3. Something else"
      </step_2b_if_no>
    </scenario_8_ambiguous_input>
  </routing_scenarios>

  <incremental_update_handler>
    <!-- From Opus review Part 7: Incremental Position Updates -->

    <add_position>
      STEP 1: Collect position details
        Ask same questions as Mode 1 position loop:
        - "What was your job title?"
        - "Which company?"
        - "What were your dates of employment?"
        - "Tell me about your responsibilities..."

      STEP 2: Generate v2.0 sections
        - Use skills-categorizer.md for hard/soft separation
        - Generate professional_summary for this role
        - Extract all 12 sections

      STEP 3: Insert at correct chronological position
        - Sort positions by dates (most recent first)
        - Insert new position in array

      STEP 4: Recalculate aggregates
        - Update total_years_experience
        - Rebuild skills aggregation (all hard/soft skills across positions)

      STEP 5: Save and confirm
        SAVE to: claude_generated_job_history_summaries_v2.txt
        CONFIRM: "Added [Title] at [Company]. Job history now has [N] positions."
    </add_position>

    <edit_position>
      STEP 1: User selects position
        LIST positions: "Which position? 1. Company A (2021-2023) 2. Company B (2019-2021)"

      STEP 2: Show current values
        DISPLAY: Current job_title, company, dates, responsibilities, etc.

      STEP 3: Ask what to change
        "What would you like to update? (You can change multiple fields)"

      STEP 4: Update in place
        - Modify selected fields
        - Re-categorize skills if skills changed
        - Regenerate professional_summary if major changes

      STEP 5: Recalculate aggregates
        - Update total_years_experience if dates changed
        - Rebuild skills aggregation

      STEP 6: Save and confirm
        SAVE changes
        CONFIRM: "Updated [Title] at [Company]."
    </edit_position>

    <remove_position>
      STEP 1: User selects position
        LIST positions for deletion

      STEP 2: Confirm deletion
        WARN: "Are you sure? This will remove [Title] at [Company] from your job history."

      STEP 3: Remove from array
        - Delete position from positions array

      STEP 4: Recalculate aggregates
        - Update total_years_experience
        - Rebuild skills aggregation

      STEP 5: Save and confirm
        SAVE changes
        CONFIRM: "Removed [Title] at [Company]. Job history now has [N] positions."
    </remove_position>
  </incremental_update_handler>

  <re_comparison_handler>
    <!-- From Opus review Part 7: JD Re-Comparison -->

    <workflow>
      STEP 1: Check for previous comparison
        - User provides JD identifier (company name, job title)
        - Search jd_cache for matching JD
        - Location: /mnt/project/jd_parsed/[company]_[job]_parsed.json

      STEP 2a: If cached JD found
        LOAD: Previous parsed JD
        DISPLAY: "Found your comparison from [date]. Re-running with updated job history..."
        SKIP: JD parsing (use cached version)

      STEP 2b: If cached JD not found
        DISPLAY: "I don't have that JD saved. Please paste the job description again."
        WAIT: For user to provide JD text
        PARSE: Using jd-processing.md (17-point schema)
        CACHE: Save parsed JD for future re-comparisons

      STEP 3: Run evidence matcher
        - Use shared/modules/evidence-matching.md
        - Match against CURRENT job_history_v2.0.json
        - Generate requirement-by-requirement analysis

      STEP 4: Generate diff output
        IF previous comparison exists:
          COMPARE: Current results vs previous results
          HIGHLIGHT:
          - Improvements (Missing → Matched, Partial → Matched)
          - Regressions (Matched → Missing - rare but possible)
          - No change (still Matched, still Missing)
          - Score delta (e.g., 72% → 81%)

        OUTPUT:
        ```
        ## Changes Since Last Comparison

        ### Improvements
        - [MISSING → MATCHED] Salesforce: Now matched from your new position at Acme Corp
        - [PARTIAL → MATCHED] Python: Updated context with new project details

        ### No Change
        - [MATCHED] SQL, Agile, Leadership
        - [MISSING] Kubernetes (still not in your history)

        ### Overall Score: 72% → 81% (+9 points)
        ```

      STEP 5: Store versioned comparison
        SAVE: /mnt/project/jd_parsed/[company]_[job]_v2_parsed.json
        KEEP: Previous version as v1 for history
    </workflow>

    <cache_management>
      User commands:
      - "Clear JD cache" → Delete all /mnt/project/jd_parsed/ files
      - "List saved JDs" → Show all cached comparisons with dates
      - "Delete [Company] JD" → Remove specific cached JD
    </cache_management>
  </re_comparison_handler>
</workflow_router>
```

**Key Features (from Opus review):**
- 8 routing scenarios (5 core + 3 additional)
- JD validation heuristics (avoid false positives)
- Override commands for force-routing
- Incremental update logic (add/edit/remove positions)
- Re-comparison with diff generation
- Ambiguous input handling (two-step clarification)

---

## Files to Modify (1 File - Surgical Change)

### Modification 1: `PROJECT-INSTRUCTIONS.md`

**Changes:**

**Location 1: After line 15 (before mode detection)**
```xml
<!-- ADD THIS SECTION -->
<entry_point_routing>
  Before executing any mode, consult shared/modules/workflow-router.md to:
  1. Detect user state (hasJobHistory, hasJD, hasResume)
  2. Identify user intent (which workflow to execute)
  3. Confirm with user before proceeding
  4. Handle override commands (re-analyze, start fresh, add position, etc.)

  The router handles 8 scenarios:
  - New user (no job history)
  - JD comparison (has job history + JD)
  - Bullet optimization (has job history + wants optimization)
  - Ambiguous (has job history, unclear intent)
  - First interaction (no context)
  - Incremental update (add/edit/remove position)
  - Re-comparison (re-run JD analysis with updated history)
  - Ambiguous input (cannot determine type)

  ALWAYS route through workflow-router.md first
</entry_point_routing>
```

---

## Implementation Steps

### Step 1: Create Workflow Router Module
```bash
# Create workflow-router.md in shared/modules/
# Write all 8 routing scenarios
# Include incremental update handler
# Include re-comparison handler
```

**Validation:**
- Test all 8 scenarios with sample inputs
- Verify JD validation heuristics work
- Check override commands trigger correct modes

---

### Step 2: Modify PROJECT-INSTRUCTIONS.md
```bash
# Add entry routing section after line 15
# Preserve all existing logic
```

**Validation:**
- Router consulted before mode execution
- User confirmation requested
- Override commands work

---

### Step 3: Create JD Cache Directory
```bash
# Create directory for storing parsed JDs
mkdir -p /mnt/project/jd_parsed/
```

**Validation:**
- Directory exists
- Permissions allow read/write

---

## Testing Checklist

### Router Tests (8 Scenarios)

- [ ] Scenario 1: New user uploads resume → routes to Mode 1
- [ ] Scenario 2: User with job history pastes JD → routes to Mode 3
- [ ] Scenario 3: User says "optimize bullets" → routes to Mode 2
- [ ] Scenario 4: User with job history, unclear intent → asks for clarification
- [ ] Scenario 5: First interaction, no context → shows welcome message
- [ ] Scenario 6: User says "add position" → incremental update handler
- [ ] Scenario 7: User says "compare again" → re-comparison handler
- [ ] Scenario 8: Ambiguous input → two-step clarification

### JD Validation Tests

- [ ] Structured JD (clear sections) → detected with high confidence
- [ ] Conversational JD (narrative) → detected with medium confidence
- [ ] LinkedIn post (looks like JD) → low confidence, asks user to confirm
- [ ] Short text (<200 words) → not detected as JD
- [ ] Very long text (>5000 words) → not detected as JD

### Override Command Tests

- [ ] User says "re-analyze" with existing job history → forces Mode 1
- [ ] User says "start fresh" → deletes v2.0 file, forces Mode 1
- [ ] User says "add position" → incremental update mode
- [ ] User says "edit position" → incremental update mode
- [ ] User says "remove position" → incremental update mode

### Incremental Update Tests

**Add Position:**
- [ ] Collects all required fields (job title, company, dates)
- [ ] Generates v2.0 sections (12 sections)
- [ ] Inserts at correct chronological position
- [ ] Recalculates total_years_experience
- [ ] Rebuilds skills aggregation
- [ ] Saves to v2.0 file
- [ ] Confirms addition with position count

**Edit Position:**
- [ ] Lists existing positions for selection
- [ ] Shows current values
- [ ] Updates selected fields
- [ ] Recalculates aggregates if dates changed
- [ ] Saves changes
- [ ] Confirms update

**Remove Position:**
- [ ] Lists positions for deletion
- [ ] Confirms with user (Are you sure?)
- [ ] Removes from array
- [ ] Recalculates aggregates
- [ ] Saves changes
- [ ] Confirms removal with new position count

### Re-Comparison Tests

- [ ] User provides JD identifier (company + job title)
- [ ] System finds cached JD from previous comparison
- [ ] Loads cached JD (skips re-parsing)
- [ ] Runs evidence matcher with CURRENT job history
- [ ] Generates diff output (improvements, no change, regressions)
- [ ] Shows score delta (e.g., 72% → 81%)
- [ ] Stores versioned comparison (v1, v2)
- [ ] If cached JD not found, asks user to paste JD again

### Cache Management Tests

- [ ] "List saved JDs" → shows all cached comparisons
- [ ] "Delete [Company] JD" → removes specific cached JD
- [ ] "Clear JD cache" → deletes all cached JDs
- [ ] Cache persists across sessions

---

## Dependencies

**Requires:**
- ✅ v6.0.2 (Mode 1, Mode 3 enhancements)
- ✅ Evidence matcher module

**Required by:**
- v6.0.4 (summary generator will use router context)

---

## Success Criteria

v6.0.3 is successful if:

1. ✅ Router detects all 8 scenarios correctly (100%)
2. ✅ JD validation avoids false positives (>95% accuracy)
3. ✅ Override commands work reliably (100%)
4. ✅ Incremental updates modify job history without errors
5. ✅ Re-comparison generates diff output correctly
6. ✅ JD cache persists across sessions
7. ✅ User confirmation requested before all mode executions
8. ✅ No regressions in existing functionality

---

## Issues & Mitigations

### Issue 1: JD Detection False Positives (from plan Issue #4)

**Problem:** LinkedIn posts or articles might look like JDs.

**Mitigation:**
- JD validation heuristics (length, keywords, structure)
- Low-confidence detection asks user to confirm
- User can always override with explicit command

### Issue 2: Incremental Update Complexity

**Problem:** Adding a position requires collecting all 12 sections.

**Mitigation:**
- Reuse Mode 1 question flow (same questions)
- Clear step-by-step prompts
- Allow partial data (mark missing sections as "Not specified")

### Issue 3: Re-Comparison JD Not Found

**Problem:** User wants to re-compare but didn't cache original JD.

**Mitigation:**
- Clear error message: "I don't have that JD saved"
- Ask user to paste JD again
- Parse and cache for future re-comparisons

---

## Next Steps

**After v6.0.3 Completes:**

1. **Git Workflow:**
   ```bash
   git checkout -b v6.0.3-router-workflows
   git add shared/modules/ PROJECT-INSTRUCTIONS.md
   mkdir -p /mnt/project/jd_parsed
   git commit -m "feat(v6.0.3): add workflow router, incremental updates, and re-comparison"
   git push origin v6.0.3-router-workflows
   ```

2. **Testing:**
   - Test all 8 routing scenarios
   - Test incremental updates (add/edit/remove)
   - Test re-comparison with cached JD
   - Test cache management commands

3. **Proceed to v6.0.4:**
   - Build professional summary generator
   - Add master summary (Mode 1)
   - Add per-JD summary customization (Mode 3)
   - Update documentation (CHANGELOG, PROJECT-INSTRUCTIONS)
   - See `/docs/plans/v6.0.4-summary-polish.md`

---

**Plan Created:** 2025-12-28
**Token Budget:** 49,000 tokens (estimated)
**Dependencies:** v6.0.2 (required)
**Next Phase:** v6.0.4 Summary & Polish
