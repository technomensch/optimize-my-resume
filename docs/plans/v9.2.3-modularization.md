# Implementation Plan: v9.2.3 - Modularization & Refactor

**Status:** Planned (deferred from v9.2.2)
**Branch:** v9.2.3-modularization (create after v9.2.2)
**Scope:** Extract validators into modules, reduce file size to Artifacts limit

---

## Rationale

The v9.2.2 implementation will have ~3949 lines in a single JSX file, which:
- Exceeds Claude Artifacts soft limit (~2000 lines)
- Makes testing and maintenance difficult
- Couples UI logic with validation logic
- Prevents reuse of validators in other contexts

**v9.2.3 Goal:** Split validators into 6-7 dedicated modules while keeping UI file under 2000 lines.

---

## Architecture: Module Structure

```
src/
├── validators/
│   ├── index.js                           # Main export
│   ├── core-validators.js                 # Task 1: Core bugs (5 validators)
│   ├── guardrail-validators.js            # Task 2: Critical guardrails (8 validators)
│   ├── content-validators.js              # Task 3: Content quality (7 validators)
│   ├── shared-module-validators.js        # Task 4: Shared modules (3 validators)
│   ├── secondary-validators.js            # Task 5: Moderate validators (2 validators)
│   ├── history-parser.js                  # Task 6: parseOriginalHistory() helper
│   └── matching-helper.js                 # Task 7: findBestMatch() helper
├── components/
│   └── Should-I-Apply-local.jsx          # Reduced to ~1800 lines
```

---

## Modules Breakdown

### Task 1: `core-validators.js` (5 validators)
**Purpose:** Fix the 5 core bugs that caused bullet deletion

| Validator | Purpose |
|-----------|---------|
| `validateChronologyDepth()` | Ensure positions meet age criteria |
| `validatePositionMetadata()` | Match bullets to job history (non-destructive) |
| `validateChronologicalOrder()` | Sort positions newest-first |
| `validateBulletCounts()` | Ensure 3-5 bullets per position |
| `validateBulletFormat()` | Check em-dash and format compliance |

**Export:**
```javascript
export const coreValidators = [
  validateChronologyDepth,
  validatePositionMetadata,
  validateChronologicalOrder,
  validateBulletCounts,
  validateBulletFormat
];
```

### Task 2: `guardrail-validators.js` (8 validators)
**Purpose:** Enforce critical guardrails from PROJECT-INSTRUCTIONS.md

| Validator | Guardrail # | Purpose |
|-----------|-------------|---------|
| `validateMetricTraceability()` | #1 | All metrics traceable to JD |
| `validateSummaryAbstraction()` | #3 | Summary doesn't echo bullets |
| `validateVerbDiversity()` | #9 | Varies verb choices |
| `validateSummaryMetrics()` | #13 | Metrics reconciled in summary |
| `validatePhraseRepetition()` | #15 | No phrase repeated 3+ times |
| `validateMetricPreservation()` | #29 | Metrics not lost during optimization |
| `validateKeywordEvidence()` | #32 | Only evidenced keywords used |
| `validateNarrativeFit()` | #33 | Narrative matches job trajectory |

**Export:**
```javascript
export const guardrailValidators = [
  validateMetricTraceability,
  validateSummaryAbstraction,
  validateVerbDiversity,
  validateSummaryMetrics,
  validatePhraseRepetition,
  validateMetricPreservation,
  validateKeywordEvidence,
  validateNarrativeFit
];
```

### Task 3: `content-validators.js` (7 validators)
**Purpose:** Validate content quality and constraints

| Validator | Constraint | Purpose |
|-----------|-----------|---------|
| `validateLimitationEnforcement()` | #5 | Limitations not overstated |
| `validateSkillClassification()` | #7 | Skills in correct tier |
| `validateBudgetEnforcement()` | #8 | Claims within budget |
| `validateKeywordDensity()` | #10 | Keywords 15-25% density |
| `validateMetricPlausibility()` | #11 | Metrics realistic for role |
| `validateScopeAttribution()` | #17 | Credit correctly attributed |
| `validateEmDash()` | #22 | Format: "Verb phrase – metric" |

**Export:**
```javascript
export const contentValidators = [
  validateLimitationEnforcement,
  validateSkillClassification,
  validateBudgetEnforcement,
  validateKeywordDensity,
  validateMetricPlausibility,
  validateScopeAttribution,
  validateEmDash
];
```

### Task 4: `shared-module-validators.js` (3 validators)
**Purpose:** Enforce shared module rules from optimization-tools/

| Validator | Module | Rule |
|-----------|--------|------|
| `validateVerbDistribution()` | shared_verb_taxonomy.md | 5% threshold, 13-27% per category |
| `validateMetricsDensity()` | shared_core_principles.md | 70-80% bullets with metrics |
| `validateKeywordEvidenceTier()` | shared_keyword_validation.md | Tier 1/2/3 weighting |

**Export:**
```javascript
export const sharedModuleValidators = [
  validateVerbDistribution,
  validateMetricsDensity,
  validateKeywordEvidenceTier
];
```

### Task 5: `secondary-validators.js` (2 validators)
**Purpose:** Moderate priority validators

| Validator | Purpose |
|-----------|---------|
| `validateRecencyWeighting()` | Recent roles emphasized |
| `validateAcronymExpansion()` | Acronyms expanded on first use |

**Export:**
```javascript
export const secondaryValidators = [
  validateRecencyWeighting,
  validateAcronymExpansion
];
```

### Task 6: `history-parser.js`
**Purpose:** Extract and parse job history with fallback

**Exports:**
```javascript
export async function parseOriginalHistory(
  selectedModel,
  jobHistorySource,
  resumeSource
) {
  // Try LLM first
  // Fall back to 3 regex patterns if LLM fails
  // Return { positions, parsingMethod, errors }
}

const historyPatterns = {
  pattern1: /(\w+[\w\s]*?)\s+(?:at|@)\s+(\w+[\w\s]*?)\s*\(([^)]+)\)/gi,
  pattern2: /(\w+[\w\s]*?)\s*\|\s*(\w+[\w\s]*?)\s*\|\s*([^|]+)/gi,
  pattern3: /(?:^|\n)(\d{1,2}\/\d{1,2}\/\d{4})\s*-\s*(?:Present|[0-9\/]+)\s*(?:\n)?(\w+[\w\s]*?)\s*(?:at|@|,)?\s*(\w+[\w\s]*?)/gim
};
```

### Task 7: `matching-helper.js`
**Purpose:** 4-strategy position matching to prevent false negatives

**Exports:**
```javascript
export function findBestMatch(bulletPosition, jobHistory) {
  // Strategy 1: Exact match (case-insensitive)
  // Strategy 2: Contains match (either direction)
  // Strategy 3: Levenshtein distance ≤ 3
  // Strategy 4: Word overlap > 50%
  // Return: matched job or null
}

export function levenshteinDistance(str1, str2) {
  // Calculate edit distance for fuzzy matching
}

export function wordOverlap(str1, str2) {
  // Calculate word overlap percentage
}
```

---

## UIComponent Changes (Should-I-Apply-local.jsx)

### Before v9.2.3:
- 3949 lines (all validators inline)
- Hard to test individual validators
- Cannot validate in other contexts
- Exceeds Artifacts limit

### After v9.2.3:
- ~1800 lines (UI logic only)
- Validator logic moved to modules
- Improved testability
- Under Artifacts limit (~2000 line soft cap)

**Integration at Component Load:**
```javascript
import {
  coreValidators,
  guardrailValidators,
  contentValidators,
  sharedModuleValidators,
  secondaryValidators
} from '../validators';
import { parseOriginalHistory } from '../validators/history-parser';
import { findBestMatch } from '../validators/matching-helper';

// In useEffect or where currently defined:
const validateAndCorrectLLMResponse = async (
  parsedContent,
  jobHistory,
  jdInfo,
  keywordsToUse,
  honestLimitations,
  options
) => {
  // Call validators from imported modules
  // Keep regeneration loop logic here
};
```

---

## Implementation Tasks

| # | Task | Effort | Notes |
|---|------|--------|-------|
| 1 | Create `core-validators.js` | Medium | Highest priority (fixes bugs) |
| 2 | Create `guardrail-validators.js` | Medium | 8 guardrail validators |
| 3 | Create `content-validators.js` | Medium | 7 content quality validators |
| 4 | Create `shared-module-validators.js` | Small | Wrapper validators for shared rules |
| 5 | Create `secondary-validators.js` | Small | 2 moderate priority validators |
| 6 | Create `history-parser.js` | Medium | Robust parsing with 3 fallback patterns |
| 7 | Create `matching-helper.js` | Small | Helper functions for position matching |
| 8 | Create `validators/index.js` | Small | Export all validators |
| 9 | Update `Should-I-Apply-local.jsx` | Medium | Import and integrate modules |
| 10 | Update `Should-I-Apply-webgui.jsx` | Medium | Same changes as local version |
| 11 | Add unit tests | High | Test each validator independently |
| 12 | Test integration | High | Verify all validators work together |

---

## Testing Strategy

### Unit Tests (Per Validator)
```javascript
// tests/validators/core-validators.test.js
describe('validateChronologyDepth', () => {
  it('should include positions ≤6 years old', () => {...});
  it('should include tenure exceptions (≥5 years, >6 years)', () => {...});
  it('should exclude very old positions (<5 years tenure, >6 years)', () => {...});
});
```

### Integration Tests
```javascript
// tests/validators/integration.test.js
describe('Full Validation Pipeline', () => {
  it('should preserve all bullets even if history parsing fails', () => {...});
  it('should run regeneration loop for critical failures', () => {...});
  it('should skip position validators when history is empty', () => {...});
});
```

### File Size Verification
```bash
wc -l src/validators/*.js     # Verify each module < 500 lines
wc -l src/components/Should-I-Apply-local.jsx  # Should be ~1800 lines
```

---

## Success Criteria

✅ All validators moved to modules (none inline in JSX)
✅ `src/components/Should-I-Apply-local.jsx` reduced to ~1800 lines
✅ Can import and use validators independently
✅ Unit tests for each validator module
✅ Integration tests for full pipeline
✅ Existing functionality preserved (regeneration loop, graceful degradation)
✅ Works in both local and Artifacts versions
✅ Under Artifacts rendering limit (~2000 lines)

---

## Files to Create/Modify

| File | Status | Lines | Action |
|------|--------|-------|--------|
| `src/validators/index.js` | Create | ~20 | Export all modules |
| `src/validators/core-validators.js` | Create | ~400 | 5 core validators |
| `src/validators/guardrail-validators.js` | Create | ~500 | 8 guardrail validators |
| `src/validators/content-validators.js` | Create | ~350 | 7 content validators |
| `src/validators/shared-module-validators.js` | Create | ~200 | 3 shared validators |
| `src/validators/secondary-validators.js` | Create | ~100 | 2 secondary validators |
| `src/validators/history-parser.js` | Create | ~300 | History parsing with fallback |
| `src/validators/matching-helper.js` | Create | ~150 | Matching and distance helpers |
| `src/components/Should-I-Apply-local.jsx` | Modify | ~1800 | Import modules, remove inline validators |
| `claude-artifacts/Should-I-Apply-webgui.jsx` | Modify | ~1800 | Same as local version |
| `tests/validators/*.test.js` | Create | ~500 | Unit and integration tests |

---

## Timeline

**v9.2.3 Branch:**
1. Create all 7 validator modules
2. Create unit tests
3. Update JSX files to import validators
4. Integration testing
5. Push to origin as `v9.2.3-modularization`
6. Merge to `main` after verification

**Expected reduction:** 3949 lines → 1800 lines (JSX) + 2000 lines (modules + tests)

---

## Next Steps

1. Complete v9.2.2 implementation (bug fixes)
2. Test v9.2.2 locally to verify bullets display
3. Commit v9.2.2 to origin
4. Create v9.2.3 branch
5. Follow modularization plan above
6. PR v9.2.3 to main with full test coverage

---

## Reference

- v9.2.2 Bug Fixes: [docs/plans/v9.2.2-fix-bullet-display-bug.md](v9.2.2-fix-bullet-display-bug.md)
- Original Plan: [docs/plans/v9.2.1-issue-79-webgui-bullet-generation-fix.md](v9.2.1-issue-79-webgui-bullet-generation-fix.md)
- Issue Tracking: [docs/issues/issue-79/implementation-log.md](../issues/issue-79/implementation-log.md)
