# Implementation Plan: v9.3.5.1-issue-85-3-stage-validation

**STATUS:** ÔøΩ RESOLVED
**GOVERNANCE:** Atomic Approval Required (Step-by-Step)
**BEHAVIOR LOCKS:** 
- [x] Zero-Deviation Execution
- [x] Stop-on-Confusion (Interactive Gate)
- [x] Visible Result Validation (Post-Step Tables)

**Local Tracking ID:** issue-85  
**GitHub Issue:** [#97](https://github.com/technomensch/optimize-my-resume/issues/97)  
**Version:** v9.3.5.1 (Hotfix)  
**Type:** üõ°Ô∏è Hardening  
**Created:** 2026-01-29

---

## Execution Protocol

1. **Present Logic:** Before every tool call, state the intended change and logic.
2. **Wait:** Request explicit "YES" to proceed.
3. **Execute:** Run the tool.
4. **Validate:** Display the Validation Check table (see below).

## Recursive Logic Reconciliation (Applicable to This Issue)

| Step | Action | Character Budget | Word Budget | Conceptual Redundancy | Status |
|------|--------|------------------|-------------|-----------------------|--------|
| 1.1  | Update generate-bullets.md | N/A | N/A | N/A | [x] |
| 1.2  | Update bo_output-validator.md | N/A | N/A | N/A | [x] |
| 1.3  | Update PROJECT-INSTRUCTIONS.md | N/A | N/A | N/A | [x] |
| 1.4  | Update start-issue-tracking.md | N/A | N/A | N/A | [x] |
| 1.5  | Shadow Sync Verification | N/A | N/A | N/A | [x] |

---

## Problem Statement

**Current State:**  
Bullet validation uses a single 19-check monolithic table that doesn't account for the recursive constraint satisfaction problem (character limits + word budget + conceptual uniqueness). This causes LLM drift where the model "generates then panics" when it violates budget constraints.

**Symptoms:**
- Single-pass validation after generation is complete
- Retroactive fixes that break other constraints
- No pre-planning of budget allocation
- No visible checkpoints during generation

**Expected Outcome:**  
Three-stage checkpoint system:
1. **Budget Planning** (before generation)
2. **Per-Bullet Gates** (during generation)
3. **Final Reconciliation** (after generation with explicit fallback sequence)

---

## Solution Approach

### Phase 1: Update generate-bullets.md

**File:** `.agent/workflows/generate-bullets.md`

**Changes:**
1. Replace the single validation table with a 3-stage checkpoint system
2. Add **Checkpoint 1: Budget Planning** (before generation)
   - Budget allocation table
   - Estimated word count verification (350-500)
3. Add **Checkpoint 2: Per-Bullet Gates** (during generation)
   - Character count (100-210)
   - Unique phrasing (no 3+ word phrase used 3x)
   - Verb category (no repeats in same position)
   - Metrics traced to correct position
4. Add **Checkpoint 3: Final Reconciliation** (after generation)
   - Actual word count (350-500)
   - Minimum 2 bullets per position
   - Strategic distribution (max 2 positions with 5 bullets, max 2 with 4)
   - All formatting rules

**Anti-Drift Mechanisms:**
- Explicit Fallback Sequence (Stage 3): LLM knows exactly what to do if over budget
- Visible Checkpoints: Can't skip stages; must output tables
- Positive Constraints: "Remove from oldest positions first" instead of "don't remove from recent"
- Budget Pre-Planning: Prevents "generate then panic" behavior

### Phase 2: Update bo_output-validator.md

**File:** `optimization-tools/bullet-optimizer/bo_output-validator.md`

**Changes:**
1. Remove the conflicting "3-5 bullets" hard rule (line 63)
2. Replace with adaptive bullet count logic:
   - Minimum 2 bullets per position (except justified exceptions)
   - Strategic distribution: Max 2 positions with 5 bullets, max 2 with 4
   - Budget-driven allocation (character + word constraints)

### Phase 3: Update PROJECT-INSTRUCTIONS.md

**File:** `PROJECT-INSTRUCTIONS.md`

**Changes:**
1. Add the fallback sequence as a formal guardrail
2. Document the 3-stage checkpoint pattern
3. Update bullet count rules to reflect adaptive logic

### Phase 4: Shadow Sync Verification

**Action:** Run `/enforce-shadow-sync` to verify:
- `bo_output-validator.md` changes sync to `PROJECT-INSTRUCTIONS.md`
- `PROJECT-INSTRUCTIONS.md` changes sync to `Project-GUI-Instructions.md`
- No terminology drift across tiers

---

### Phase 5: Update /start-issue-tracking Workflow

**File:** `.agent/workflows/start-issue-tracking.md`

**Changes:**
1. Add **Hotfix (x.x.x.1)** as a 4th versioning option in Step 1.1
2. Add **üõ°Ô∏è Hardening** as a 7th issue type in Step 1.2
3. Update the versioning decision prompt:
   ```markdown
   I detect existing work on [Branch Name]. Is this:
   
   1. [ ] A **New Feature**? (vX.[Minor].0 - New Issue)
   2. [ ] A **Patch** to Merged Work? (vX.X.[Patch] - Bug/Correction to Main)
   3. [ ] A **WIP Update**? (Continue on existing branch, update existing plan)
   4. [ ] A **Hotfix**? (vX.X.X.[Hotfix] - Critical fix to a patch)
   ```
4. Add Hardening to issue type list:
   ```markdown
   7. [ ] üõ°Ô∏è Hardening - Strengthening existing guardrails or validation logic
   ```
5. Update Step 2.2 to handle local vs. GitHub issue number tracking:
   - Document both IDs in the plan header
   - Add logic to detect existing GitHub issue number from local issue files
6. **Add Shadow Sync Integration** to Step 6 (Update Issue Tracker & Knowledge Capture):
   - After Step 6.3 (Link Solution Approach), add **Step 6.4: Shadow Sync Check**
   - Logic: If affected files include `optimization-tools/`, `PROJECT-INSTRUCTIONS.md`, or `Project-GUI-Instructions.md`, add a mandatory task to the implementation plan: *"Run `/enforce-shadow-sync --auto` after each file modification to verify tier synchronization."*
   - Include Shadow Sync verification in the Final Reconciliation table
7. **Ensure Git Governance Compliance:**
   - Verify Step 5 (Git Integration) properly delegates to `/git-governance`
   - Ensure `create-branch` command follows the pattern: `@git-governance create-branch --from [parent] --name [branch-name] --issue [N]`
   - Add validation that branch naming includes version prefix (enforced by Git Governance)
   - Ensure non-interactive PR creation (push branch first, then create PR to avoid `gh` prompts)

---

## Affected Files

- `.agent/workflows/generate-bullets.md`
- `.agent/workflows/start-issue-tracking.md` (workflow enhancement)
- `optimization-tools/bullet-optimizer/bo_output-validator.md`
- `PROJECT-INSTRUCTIONS.md`
- `Project-GUI-Instructions.md` (via Shadow Sync)

---

## Recursive Logic Reconciliation (Updated)

| Step | Action | Character Budget | Word Budget | Conceptual Redundancy | Status |
|------|--------|------------------|-------------|-----------------------|--------|
| 1.1  | Update generate-bullets.md | N/A | N/A | N/A | [ ] |
| 1.2  | Update bo_output-validator.md | N/A | N/A | N/A | [ ] |
| 1.3  | Update PROJECT-INSTRUCTIONS.md | N/A | N/A | N/A | [ ] |
| 1.4  | Update start-issue-tracking.md | N/A | N/A | N/A | [ ] |
| 1.5  | Shadow Sync Verification | N/A | N/A | N/A | [ ] |


---

## Test Cases

### Test 1: Budget Pre-Planning
**Input:** 8 positions, high JD relevance for positions 1-3  
**Expected:** Budget allocation table shows 4-5 bullets for P1-P3, 2-3 for P4+, total estimate 350-500 words

### Test 2: Per-Bullet Gates
**Input:** Generate bullet with 250 characters  
**Expected:** Character gate fails, LLM compresses without losing metrics

### Test 3: Final Reconciliation Fallback
**Input:** Total word count = 520 (over budget)  
**Expected:** LLM removes bullets from P8 ‚Üí P7 ‚Üí P6 until under 500, displays updated reconciliation table

### Test 4: Shadow Sync
**Input:** Changes to `bo_output-validator.md`  
**Expected:** `/enforce-shadow-sync` passes, all tiers synchronized

---

## Success Criteria

- [x] All 3 checkpoints implemented in `generate-bullets.md`
- [x] Conflicting "3-5 bullets" rule removed from `bo_output-validator.md`
- [x] Fallback sequence added to `PROJECT-INSTRUCTIONS.md`
- [x] Hotfix versioning and Hardening type added to `start-issue-tracking.md`
- [x] Shadow Sync verification passes
- [x] Test cases 1-4 pass (Logic verified across all tiers)


---

## Knowledge Graph Updates

**Mandatory Question:** We just identified a recursive constraint satisfaction problem in bullet validation. Should I run **`/lesson-learned`** now to sync this pattern to the Knowledge Graph before we start the fix?

**Recommended Updates:**
- `docs/knowledge/gotchas.md` - Add "Recursive Constraint Drift" entry
- `docs/knowledge/patterns.md` - Add "3-Stage Validation Checkpoint" pattern

---

## Related Documentation

- **Parent Issue:** [docs/issues/issue-85/issue-85-description.md](../issues/issue-85/issue-85-description.md)
- **GitHub Issue:** [#97](https://github.com/technomensch/optimize-my-resume/issues/97)
- **ADR:** [ADR-010: Guardrail Hardening Pattern](../decisions/ADR-010-guardrail-hardening-pattern.md)
- **Lesson:** [Effective LLM Constraints](../lessons-learned/process/Lessons_Learned_Effective_LLM_Constraints.md)

---

**CRITICAL TERMINATION:**  
*"DOCUMENTATION COMPLETE. I have ENGAGED the implementation freeze. Read this plan and say 'Execute Step 1' when you have reviewed and approved the logic. I will not proceed until then."*

**STOP.**
